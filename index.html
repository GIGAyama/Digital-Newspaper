<!DOCTYPE html>
<html lang="ja">
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¯ãƒ©ã‚¹æ–°èç¤¾</title>
    <!-- Pico.css -->
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.5.10/css/pico.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary: #2c3e50;
        --accent: #3498db;
        --bg: #f4f6f8;
        --card-bg: #ffffff;
        --text: #000000;
      }

      body {
        font-family: "BIZ UDPGothic", "Helvetica Neue", sans-serif;
        background-color: var(--bg);
        color: var(--text);
        padding-top: 30px;
        padding-bottom: 50px;
      }
      
      ruby { ruby-position: over; }
      rt { font-size: 0.6em; color: #555; font-weight: normal; }

      .container { 
        max-width: 650px; 
        background: var(--card-bg); 
        padding: 40px; 
        border-radius: 12px; 
        box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
        border: 1px solid #e1e4e8; 
      }
      
      header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #f0f0f0; padding-bottom: 20px; }
      h1 { color: #2c3e50; font-weight: 700; margin-bottom: 10px; font-size: 1.8rem; letter-spacing: 0.05em; }
      .subtitle { color: #666; font-size: 0.95rem; }
      
      .form-group { margin-bottom: 25px; }
      
      label.input-label { 
        font-weight: 700; color: #2c3e50; font-size: 1rem; margin-bottom: 8px; 
        display: block; border-left: 4px solid var(--accent); padding-left: 10px;
      }

      input[type="text"], textarea { 
        border: 2px solid #cbd5e0 !important; 
        border-radius: 6px !important; 
        padding: 12px !important; 
        font-size: 1.1rem; 
        color: #000000 !important; 
        font-weight: 500;
        background: #fff;
        transition: 0.2s;
        box-shadow: none !important;
      }
      input[type="text"]::placeholder, textarea::placeholder { color: #888; font-weight: normal; }
      input[type="text"]:focus, textarea:focus { 
        border-color: var(--accent) !important; 
        background: #fff;
        box-shadow: 0 0 0 4px rgba(52,152,219,0.2) !important; 
      }
      
      .tag-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
      .tag-radio { display: none; }
      .tag-label {
        display: flex; align-items: center; justify-content: center;
        background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px;
        padding: 12px; cursor: pointer; transition: 0.2s;
        font-weight: bold; color: #444; font-size: 0.95rem; text-align: center;
      }
      .tag-label:hover { background: #e9ecef; }
      .tag-radio:checked + .tag-label {
        background: var(--accent); color: white; border-color: var(--accent);
        box-shadow: 0 4px 10px rgba(52,152,219,0.3); transform: translateY(-2px);
      }
      .tag-radio:checked + .tag-label rt { color: rgba(255,255,255,0.9); }
      
      .file-drop-area {
        border: 2px dashed #cbd5e0; border-radius: 8px; padding: 20px; text-align: center;
        background: #f8f9fa; transition: 0.2s; cursor: pointer;
      }
      .file-drop-area:hover { background: #fff; border-color: var(--accent); }
      input[type="file"] { margin-top: 5px; }

      button[type="submit"] { 
        background-color: #2c3e50; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; 
        padding: 16px; margin-top: 30px; width: 100%; color: white;
        box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2); transition: all 0.2s;
      }
      button[type="submit"]:hover { background-color: #34495e; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(44, 62, 80, 0.3); }
      button[type="submit"]:active { transform: translateY(0); box-shadow: none; }
      button[type="submit"]:disabled { background-color: #95a5a6; cursor: not-allowed; transform: none; box-shadow: none; }

      .admin-link {
        display: inline-block; color: #7f8c8d; text-decoration: none; font-size: 0.9rem;
        padding: 10px 20px; border: 1px solid #cbd5e0; border-radius: 6px; background: white; transition: 0.2s; cursor: pointer;
      }
      .admin-link:hover { background: #f1f3f5; color: #2c3e50; border-color: #b0b8c1; }

      #success-overlay {
        display: none; position: fixed; top:0; left:0; width:100%; height:100%; 
        background: rgba(255,255,255,0.98); z-index: 1000;
        flex-direction: column; align-items: center; justify-content: center; text-align: center;
      }
      .checkmark-circle {
        width: 100px; height: 100px; border-radius: 50%; background: #2ecc71;
        display: flex; align-items: center; justify-content: center; margin-bottom: 20px;
        animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .checkmark { color: white; font-size: 50px; }
      .success-title { font-size: 1.8rem; color: #2c3e50; font-weight: bold; margin-bottom: 10px; }
      .success-sub { font-size: 1rem; color: #7f8c8d; }
      @keyframes scaleIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
  </head>
  <body>
    <main class="container">
      <header>
        <h1>ğŸ“° ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ã‚¯ãƒ©ã‚¹<ruby>æ–°<rt>ã—ã‚“</rt>è<rt>ã¶ã‚“</rt>ç¤¾<rt>ã—ã‚ƒ</rt></ruby></h1>
        <div class="subtitle"><ruby>è¨˜<rt>ã</rt>è€…<rt>ã—ã‚ƒ</rt></ruby>ãƒšãƒ¼ã‚¸</div>
      </header>

      <form id="articleForm" onsubmit="submitForm(event)">
        
        <div class="form-group">
          <label class="input-label" for="title">â‘  <ruby>è¨˜<rt>ã</rt>äº‹<rt>ã˜</rt></ruby>ã®ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" id="title" name="title" placeholder="ä¾‹ï¼šé‹å‹•ä¼šã§ç·´ç¿’ã®æˆæœã‚’å‡ºã›ãŸã‚ˆ" required>
        </div>

        <div class="form-group">
          <label class="input-label" for="body">â‘¡ <ruby>æœ¬<rt>ã»ã‚“</rt>æ–‡<rt>ã¶ã‚“</rt></ruby> (<ruby>å†…<rt>ãªã„</rt>å®¹<rt>ã‚ˆã†</rt></ruby>)</label>
          <textarea id="body" name="body" rows="6" placeholder="ã„ã¤ã€ã©ã“ã§ã€ã ã‚ŒãŒã€ãªã«ã‚’ã—ãŸã‹ãªï¼Ÿ ãã‚ã—ãæ›¸ã„ã¦ã¿ã‚ˆã†ã€‚" required></textarea>
        </div>

        <div class="form-group">
          <label class="input-label" for="reporter">â‘¢ <ruby>è¨˜<rt>ã</rt>è€…<rt>ã—ã‚ƒ</rt></ruby>ã®<ruby>å<rt>ãª</rt>å‰<rt>ã¾ãˆ</rt></ruby></label>
          <input type="text" id="reporter" name="reporter" placeholder="è‡ªåˆ†ã®åå‰ã‚’å…¥åŠ›" required>
        </div>

        <div class="form-group">
          <label class="input-label">â‘£ ã‚¿ã‚° (<ruby>ç¨®<rt>ã—ã‚…</rt>é¡<rt>ã‚‹ã„</rt></ruby>)</label>
          <div class="tag-grid" id="tag-container">
            <div style="grid-column: 1/-1; text-align:center; color:#999;">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>

        <div class="form-group">
          <label class="input-label" for="image">â‘¤ <ruby>å†™<rt>ã—ã‚ƒ</rt>çœŸ<rt>ã—ã‚“</rt></ruby> (<ruby>æ’®<rt>ã¨</rt></ruby>ã£ãŸã‚‚ã®)</label>
          <div class="file-drop-area">
            <input type="file" id="image" name="image" accept="image/*">
            <p style="margin: 5px 0 0; font-size: 0.8rem; color: #888;">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸ã‚“ã§ã­</p>
          </div>
        </div>

        <button type="submit" id="submitBtn"><ruby>é€<rt>ãã†</rt>ä¿¡<rt>ã—ã‚“</rt></ruby>ã™ã‚‹</button>
      </form>

      <div style="margin-top: 50px; text-align: center; border-top: 1px solid #eee; padding-top: 25px;">
        <a href="<?= ScriptApp.getService().getUrl() ?>?p=admin" class="admin-link">ç·¨é›†ãƒšãƒ¼ã‚¸ã¸</a>
      </div>
    </main>

    <div id="success-overlay">
      <div class="checkmark-circle"><span class="checkmark">âœ”</span></div>
      <div class="success-title"><ruby>é€<rt>ãã†</rt>ä¿¡<rt>ã—ã‚“</rt></ruby><ruby>å®Œ<rt>ã‹ã‚“</rt>äº†<rt>ã‚Šã‚‡ã†</rt></ruby>ï¼</div>
      <div class="success-sub"><ruby>å…ˆ<rt>ã›ã‚“</rt>ç”Ÿ<rt>ã›ã„</rt></ruby>ã®ãƒ‘ã‚½ã‚³ãƒ³ã«<ruby>å±Š<rt>ã¨ã©</rt></ruby>ãã¾ã—ãŸã€‚<br>3<ruby>ç§’<rt>ã³ã‚‡ã†</rt></ruby><ruby>å¾Œ<rt>ã”</rt></ruby>ã«<ruby>æˆ»<rt>ã‚‚ã©</rt></ruby>ã‚Šã¾ã™ã€‚</div>
    </div>

    <script>
      window.onload = function() {
        google.script.run.withSuccessHandler(tags => {
          const container = document.getElementById('tag-container');
          container.innerHTML = '';
          if(!tags || tags.length === 0) {
            container.innerHTML = '<div style="grid-column:1/-1; color:red;">ã‚¿ã‚°è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
          }
          tags.forEach((t, i) => {
            const label = document.createElement('label');
            const requiredAttr = i === 0 ? 'required' : ''; 
            let rubyHtml = t.name;
            if(t.ruby) { rubyHtml = `<ruby>${t.name}<rt>${t.ruby}</rt></ruby>`; }
            label.innerHTML = `
              <input type="radio" class="tag-radio" name="tag" value="${t.name}" ${requiredAttr}>
              <div class="tag-label">
                <span style="margin-right:5px; font-size:1.2em;">${t.icon}</span> ${rubyHtml}
              </div>`;
            container.appendChild(label);
          });
        }).getTagsSettings();
      };

      // â˜… å …ç‰¢ãªé€ä¿¡å‡¦ç† (ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ã)
      function submitForm(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = 'â³ <ruby>é€<rt>ãã†</rt>ä¿¡<rt>ã—ã‚“</rt></ruby><ruby>ä¸­<rt>ã¡ã‚…ã†</rt></ruby>...';

        const form = document.getElementById('articleForm');
        
        // ã‚¿ã‚°å–å¾—
        const tagRadios = document.getElementsByName('tag');
        let selectedTag = "";
        for (const radio of tagRadios) { if (radio.checked) { selectedTag = radio.value; break; } }

        const fileInput = document.getElementById('image');
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onloadend = function() {
          const data = {
            title: form.title.value,
            body: form.body.value,
            reporter: form.reporter.value,
            tag: selectedTag,
            image: reader.result ? reader.result.split(',')[1] : null,
            mimeType: file ? file.type : null
          };

          // ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãé€ä¿¡ (æœ€å¤§3å›è©¦è¡Œ)
          trySend(data, 0);
        };

        if (file) { reader.readAsDataURL(file); } else { reader.onloadend(); }

        // å†å¸°çš„ãªãƒªãƒˆãƒ©ã‚¤å‡¦ç†
        function trySend(data, attempt) {
          google.script.run
            .withSuccessHandler(() => {
              // æˆåŠŸæ™‚
              const overlay = document.getElementById('success-overlay');
              overlay.style.display = 'flex';
              setTimeout(() => {
                form.reset();
                overlay.style.display = 'none';
                btn.disabled = false;
                btn.innerHTML = originalText;
              }, 3000);
            })
            .withFailureHandler((error) => {
              // å¤±æ•—æ™‚: åŒæ™‚å®Ÿè¡Œåˆ¶é™ãªã©ã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤
              if (attempt < 3) {
                // å¾…ã¡æ™‚é–“ã‚’å°‘ã—ãšã¤å¢—ã‚„ã™ (2ç§’, 4ç§’, 6ç§’...)
                const waitTime = (attempt + 1) * 2000;
                btn.innerHTML = `â³ æ··é›‘ä¸­...å¾…æ©Ÿ(${attempt+1}/3)`;
                setTimeout(() => {
                  trySend(data, attempt + 1);
                }, waitTime);
              } else {
                // è«¦ã‚ã‚‹
                alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦æŠ¼ã—ã¦ãã ã•ã„ã€‚\n' + error);
                btn.disabled = false;
                btn.innerHTML = originalText;
              }
            })
            .saveArticle(data);
        }
      }
    </script>
  </body>
</html>
