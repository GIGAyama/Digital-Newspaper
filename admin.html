<!DOCTYPE html>
<html lang="ja">
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°èç·¨é›†å®¤ Professional Ver.1.0</title>
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª & ãƒ•ã‚©ãƒ³ãƒˆ -->
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Yomogi&family=Kiwi+Maru:wght@400;500&family=BIZ+UDPGothic:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <!-- å°åˆ·ç”¨å‹•çš„ã‚¹ã‚¿ã‚¤ãƒ« -->
    <style id="dynamic-print-style"></style>

    <style>
      /* =========================================
         1. ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š & CSSå¤‰æ•° (Variables)
         ========================================= */
      :root {
        /* UI Colors */
        --bg-color: #f0f2f5;
        --text-color: #333;
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color-ui: #e74c3c;
        --success-color: #27ae60;
        --warning-color: #f39c12;
        
        /* Font Settings */
        --base-font: "BIZ UDPGothic", "Helvetica Neue", Arial, sans-serif;
        
        /* Paper Layout Variables (Default) */
        --paper-bg: white;
        --paper-text: #111;
        --paper-border: none;
        --layout-accent: #333;
        --paper-padding: 12mm;
        --base-font-size: 12px;
        --col-base-px: 200px;
        --global-img-scale: 0.96;
      }

      body { font-family: var(--base-font); margin: 0; padding: 20px; background: var(--bg-color); color: var(--text-color); transition: background 0.3s; }

      /* =========================================
         2. ãƒ˜ãƒƒãƒ€ãƒ¼ & ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ (Header)
         ========================================= */
      .top-bar { 
        background: linear-gradient(135deg, #2c3e50, #34495e); 
        padding: 15px 25px; border-radius: 12px 12px 0 0; 
        display: flex; gap: 15px; align-items: center; color: white; flex-wrap: wrap; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      .bar-title { font-weight: 700; font-size: 1.3rem; margin-right: auto; display: flex; align-items: center; gap: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
      .logo-icon { font-size: 1.5rem; }
      
      .top-btn { 
        background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.2); 
        padding: 8px 18px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; 
        transition: all 0.2s ease; white-space: nowrap; backdrop-filter: blur(5px);
        display: inline-flex; align-items: center; gap: 6px; font-weight: bold;
      }
      .top-btn:hover { background: rgba(255,255,255,0.25); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
      .top-btn:active { transform: translateY(1px); box-shadow: none; }
      
      /* ãƒœã‚¿ãƒ³è‰²åˆ†ã‘ */
      .btn-save { border-color: var(--success-color); background: rgba(39, 174, 96, 0.4); }
      .btn-load { border-color: #d35400; background: rgba(211, 84, 0, 0.4); }
      .btn-template { border-color: #8e44ad; background: rgba(142, 68, 173, 0.4); }
      .btn-tags { border-color: var(--secondary-color); background: rgba(52, 152, 219, 0.4); }

      /* =========================================
         3. ç®¡ç†ãƒ‘ãƒãƒ« (Admin Panel)
         ========================================= */
      .admin-panel { 
        background: white; padding: 25px; border-radius: 0 0 12px 12px; margin-bottom: 25px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #e1e4e8; border-top: none;
      }
      .config-section { display: flex; gap: 25px; flex-wrap: wrap; }
      .config-col { 
        flex: 1; min-width: 280px; background: #f8f9fa; padding: 20px; border-radius: 10px; 
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05); transition: 0.3s;
      }
      .config-col:hover { background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
      
      .config-col h3 { 
        margin-top: 0; font-size: 1.05rem; color: #444; border-bottom: 2px solid #e0e0e0; 
        padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;
      }

      .control-group { margin-bottom: 15px; }
      .control-group label { font-weight: bold; font-size: 0.85rem; display: block; margin-bottom: 6px; color: #555; }
      input[type="range"], select, input[type="text"], input[type="date"] { 
        width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; 
        box-sizing: border-box; font-size: 0.9rem; transition: 0.2s; background: white;
      }
      select:focus, input:focus { border-color: var(--secondary-color); outline: none; box-shadow: 0 0 0 3px rgba(52,152,219,0.15); }
      
      .action-btn { 
        width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; 
        font-weight: bold; color: white; margin-top: 10px; transition: 0.2s;
        display: flex; justify-content: center; align-items: center; gap: 8px;
      }
      .btn-print { background: linear-gradient(to bottom, #2ecc71, #27ae60); box-shadow: 0 4px 0 #1e8449; text-shadow: 0 1px 1px rgba(0,0,0,0.2); font-size: 1.1rem; }
      .btn-print:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #1e8449; }
      .btn-free { background: #9b59b6; margin-bottom: 15px; font-size: 0.95rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      .btn-refresh { 
        background: var(--secondary-color); color: white; border: none; padding: 4px 10px; font-size: 0.8rem; 
        border-radius: 4px; cursor: pointer; margin-left: auto; transition: 0.2s;
      }

      /* =========================================
         4. è¨˜äº‹ãƒªã‚¹ãƒˆ (Article List)
         ========================================= */
      .article-list { 
        max-height: 450px; overflow-y: auto; border: 1px solid #e1e4e8; padding: 8px; 
        background: #fff; border-radius: 8px; scrollbar-width: thin;
      }
      .article-item { 
        background: white; border: 1px solid #eee; padding: 12px; margin-bottom: 8px; 
        border-radius: 8px; transition: all 0.2s ease; border-left: 5px solid transparent; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
      }
      .article-item:hover { transform: translateX(2px); box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
      .article-item.selected { border-left-color: var(--success-color); background: #f6fffa; border-color: #c3e6cb; }
      .article-item.is-free { border-left-color: #9b59b6; background: #fdf2ff; border-color: #e2d1eb; }
      
      .item-main { display: flex; align-items: center; margin-bottom: 10px; }
      .item-tag-row { display:flex; align-items:center; gap:10px; margin-top:8px; margin-bottom:5px; flex-wrap: wrap; }
      .input-wrapper { display: flex; align-items: center; gap: 6px; background: #f1f3f5; padding: 4px 8px; border-radius: 20px; }
      .tag-input { font-size: 0.8rem; padding: 4px 8px; border: none; background: transparent; width: 80px; color: #555; }
      .qr-input { font-size: 0.8rem; padding: 4px 8px; border: none; background: transparent; width: 140px; color: var(--secondary-color); }
      
      .item-settings { 
        margin-left: 0; margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; 
        background: #f8f9fa; padding: 8px 12px; border-radius: 6px; border: 1px solid #eee; align-items: center;
      }
      .item-settings select { width: auto; font-size: 0.8rem; padding: 3px 6px; height: 28px; border: 1px solid #ccc; background: white; border-radius: 4px; }

      /* =========================================
         5. ç´™é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (Newspaper Preview)
         ========================================= */
      #paper-area { 
        background-color: var(--paper-bg); color: var(--paper-text); border: var(--paper-border);
        margin: 0 auto; padding: var(--paper-padding); 
        box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
        box-sizing: border-box; overflow: hidden; position: relative; 
        transition: background-color 0.3s, color 0.3s;
        /* èƒŒæ™¯ç”»åƒè¨­å®š */
        background-image: var(--paper-bg-image); background-size: var(--paper-bg-size); background-position: var(--paper-bg-pos); background-repeat: var(--paper-bg-repeat);
        /* å°åˆ·è¨­å®š */
        -webkit-print-color-adjust: exact; print-color-adjust: exact;
      }

      /* ãƒ†ãƒ¼ãƒã‚¯ãƒ©ã‚¹ */
      .theme-default { --paper-bg: white; }
      .theme-spring { --paper-bg: #fff0f5; --paper-text: #5d4037; --paper-border: 6px double #f8bbd0; --layout-accent: #ec407a; --paper-bg-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23f48fb1' d='M50 50 Q70 20 90 50 Q70 80 50 50 Q30 80 10 50 Q30 20 50 50'/%3E%3Ccircle cx='50' cy='50' r='10' fill='%23fce4ec'/%3E%3C/svg%3E"), url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23f06292' d='M50 50 Q70 20 90 50 Q70 80 50 50 Q30 80 10 50 Q30 20 50 50'/%3E%3C/svg%3E"), url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23f48fb1' d='M50 50 Q70 20 90 50 Q70 80 50 50 Q30 80 10 50 Q30 20 50 50'/%3E%3C/svg%3E"), url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23f06292' d='M50 50 Q70 20 90 50 Q70 80 50 50 Q30 80 10 50 Q30 20 50 50'/%3E%3C/svg%3E"); --paper-bg-size: 60px 60px, 50px 50px, 60px 60px, 50px 50px; --paper-bg-pos: top 10px left 10px, top 10px right 10px, bottom 10px right 10px, bottom 10px left 10px; --paper-bg-repeat: no-repeat; }
      .theme-summer { --paper-bg: #e1f5fe; --paper-text: #01579b; --paper-border: 4px solid #4fc3f7; --layout-accent: #0288d1; --paper-bg-image: radial-gradient(circle at 50% 100%, #81d4fa 45%, transparent 50%), radial-gradient(circle at 50% 0%, #ffeb3b 40%, #ffc107 50%, transparent 60%); --paper-bg-size: 40px 20px, 120px 120px; --paper-bg-pos: bottom left, -40px -40px; --paper-bg-repeat: repeat-x, no-repeat; }
      .theme-autumn { --paper-bg: #fffde7; --paper-text: #3e2723; --paper-border: 8px solid transparent; --layout-accent: #d84315; border-image: repeating-linear-gradient(45deg, #ffab91 0, #ffab91 10px, #ffccbc 10px, #ffccbc 20px) 10; --paper-bg-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23ff5722' d='M50 10 L60 40 L90 30 L70 60 L90 80 L60 70 L50 100 L40 70 L10 80 L30 60 L10 30 L40 40 Z'/%3E%3C/svg%3E"), url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23ffb300' d='M50 90 L50 60 Q80 10 20 10 Q60 10 50 60'/%3E%3C/svg%3E"); --paper-bg-size: 50px 50px, 40px 40px; --paper-bg-pos: top left, bottom right; --paper-bg-repeat: no-repeat; }
      .theme-winter { --paper-bg: #fafafa; --paper-text: #455a64; --paper-border: 4px solid #cfd8dc; --layout-accent: #607d8b; --paper-bg-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath stroke='%2390a4ae' stroke-width='3' d='M50 0 L50 100 M0 50 L100 50 M15 15 L85 85 M15 85 L85 15'/%3E%3C/svg%3E"), url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle fill='%23b0bec5' cx='50' cy='50' r='5'/%3E%3Cpath stroke='%23b0bec5' stroke-width='2' d='M50 20 L50 80 M20 50 L80 50'/%3E%3C/svg%3E"); --paper-bg-size: 60px 60px, 30px 30px; --paper-bg-pos: 20px 20px, 60px 50px; --paper-bg-repeat: repeat-x; }
      .theme-blackboard { --paper-bg: #2e4d3a; --paper-text: #fff; --paper-border: 12px ridge #795548; --layout-accent: #ffeb3b; background-image: radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 20px 20px; }
      .theme-frame { --paper-bg: white; --paper-text: #000; --paper-border: 4px solid #000; --paper-padding: 15mm; --layout-accent: #000; border-radius: 4px; box-shadow: inset 0 0 0 2px white, inset 0 0 0 6px #000; }

      /* ãƒ•ã‚©ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ */
      .font-mincho { font-family: "Shippori Mincho", serif !important; }
      .font-gothic { font-family: "Noto Sans JP", sans-serif !important; }
      .font-ud { font-family: "UD Digital Kyokasho-tai-R", "UD ãƒ‡ã‚¸ã‚¿ãƒ«æ•™ç§‘æ›¸ä½“ R-R", "BIZ UDPGothic", sans-serif !important; }
      .font-yomogi { font-family: "Yomogi", cursive !important; }
      .font-kiwi { font-family: "Kiwi Maru", serif !important; }

      /* ç´™é¢æ§‹æˆè¦ç´  */
      .page-a4-v { width: 210mm; height: 297mm; } .page-a4-h { width: 297mm; height: 210mm; }
      .newspaper-header { text-align: center; border-bottom: 4px double var(--layout-accent); margin-bottom: 15px; padding-bottom: 10px; height: 10%; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; color: var(--paper-text); }
      .newspaper-title { font-size: 3rem; margin: 0; line-height: 1; letter-spacing: 0.1em; outline: none; }
      .newspaper-date { text-align: right; font-size: 0.9rem; margin-top: 10px; outline: none; }
      .articles-container { width: 100%; height: 88%; }
      .article-box { margin-bottom: 15px; padding: 8px; font-size: var(--base-font-size); text-align: justify; break-inside: auto; overflow: visible; position: relative; max-width: 100%; box-sizing: border-box; min-height: 2em; color: var(--paper-text); }
      .article-box::after { content: ""; display: block; clear: both; }
      .article-title, .article-img-wrapper, .article-meta, .qr-container { break-inside: avoid; }
      
      /* ç·¨é›†å¯èƒ½ã‚¨ãƒªã‚¢ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
      [contenteditable="true"]:hover { background-color: rgba(255, 235, 59, 0.2); outline: 1px dashed #ccc; cursor: text; border-radius: 4px; }
      [contenteditable="true"]:focus { background-color: rgba(255, 235, 59, 0.3); outline: 2px solid var(--secondary-color); border-radius: 4px; }
      
      /* è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
      .article-title { font-weight: 700; font-size: 1.5em; line-height: 1.3; margin-bottom: 6px; display: block; color: var(--paper-text); }
      .title-normal .article-title { border-bottom: 2px solid var(--layout-accent); }
      .title-outline .article-title { color: var(--paper-bg); text-shadow: 1px 1px 0 var(--paper-text), -1px -1px 0 var(--paper-text), 1px -1px 0 var(--paper-text), -1px 1px 0 var(--paper-text); border-bottom: 4px solid var(--paper-text); padding: 2px 5px; }
      .title-solid .article-title { background: var(--paper-text); color: var(--paper-bg); padding: 4px 10px; border-radius: 3px; }
      .title-double .article-title { border-bottom: 3px double var(--layout-accent); padding-bottom: 2px; }
      .title-leftbar .article-title { border-left: 6px solid var(--layout-accent); padding-left: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); }
      .title-marker .article-title { background: linear-gradient(transparent 60%, rgba(255, 235, 59, 0.5) 60%); padding: 0 5px; display: inline; box-decoration-break: clone; -webkit-box-decoration-break: clone; }
      /* é»’æ¿ãƒ¢ãƒ¼ãƒ‰ç‰¹ä¾‹ */
      .theme-blackboard .title-marker .article-title { background: linear-gradient(transparent 60%, rgba(255, 255, 255, 0.3) 60%); }
      .theme-blackboard .title-outline .article-title { text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff; color: #264d36; border-color: #fff; }

      .article-meta { font-size: 0.8em; color: var(--paper-text); opacity: 0.8; margin-bottom: 5px; text-align: right; display: block; }
      .article-body { line-height: 1.7; white-space: pre-wrap; font-size: 1em; overflow-wrap: break-word; }
      .article-img-wrapper { writing-mode: horizontal-tb; display: block; margin: 5px auto 8px auto; max-width: 100% !important; box-sizing: border-box; overflow: hidden; border: 1px solid #ccc; background: white; border-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      .article-img-wrapper img { width: 100%; height: 100%; display: block; object-fit: var(--local-fit, cover); object-position: center; }
      .img-float-left { float: left; margin: 0 10px 5px 0; max-width: 50% !important; }
      .img-float-right { float: right; margin: 0 0 5px 10px; max-width: 50% !important; }
      .qr-container { display: inline-block; background: white; padding: 4px; border: 1px solid #ccc; margin-top: 5px; margin-left: 10px; text-align: center; vertical-align: top; border-radius: 4px; }
      .qr-container canvas { display: block; }
      .qr-container .qr-label { font-size: 8px; color: #333; margin-top: 2px; line-height: 1; font-family: sans-serif; font-weight: bold; letter-spacing: 0.05em; }

      /* ç¸¦æ›¸ããƒ¢ãƒ¼ãƒ‰ */
      .vertical-mode { writing-mode: vertical-rl; text-orientation: upright; column-fill: auto; }
      .vertical-mode .article-box { border-left: 1px solid rgba(0,0,0,0.1); padding-left: 10px; margin-left: 10px; margin-bottom: 0; border-bottom: none !important; padding-bottom: 0; }
      .vertical-mode .article-title { margin-left: 10px; margin-bottom: 0; }
      .vertical-mode.title-normal .article-title { border-bottom: none; border-left: 2px solid var(--layout-accent); padding-left: 5px; }
      .vertical-mode.title-outline .article-title { border-left: 4px solid var(--paper-text); border-bottom: none; }
      .vertical-mode.title-solid .article-title { border-left: none; }
      .vertical-mode.title-double .article-title { border-bottom: none; border-left: 3px double var(--layout-accent); padding-left: 5px; }
      .vertical-mode.title-leftbar .article-title { border-left: none; border-top: 6px solid var(--layout-accent); padding-top: 10px; border-bottom: none; border-right: 1px solid rgba(0,0,0,0.1); padding-right:10px; }
      .vertical-mode.title-marker .article-title { background: linear-gradient(to left, transparent 60%, rgba(255, 235, 59, 0.5) 60%); }
      .theme-blackboard .vertical-mode.title-marker .article-title { background: linear-gradient(to left, transparent 60%, rgba(255, 255, 255, 0.3) 60%); }
      .vertical-mode .img-float-left { float: left; margin: 0 0 10px 10px; }
      .vertical-mode .img-float-right { float: right; margin: 10px 0 10px 0; }
      .vertical-mode .qr-container { margin-left: 0; margin-bottom: 5px; margin-right: 5px; writing-mode: horizontal-tb; }

      /* æ®µçµ„ã¿ã‚¯ãƒ©ã‚¹ */
      .cols-1 { column-count: 1; } 
      .cols-2 { column-count: 2; column-gap: 30px; column-rule: 1px solid #ccc; }
      .cols-3 { column-count: 3; column-gap: 20px; column-rule: 1px solid #ccc; } 
      .cols-4 { column-count: 4; column-gap: 15px; column-rule: 1px solid #ccc; }

      @media print {
        body { margin: 0; padding: 0; background: white; }
        .top-bar, .admin-panel, .modal-overlay, .toast-container { display: none !important; }
        #paper-area { box-shadow: none; margin: 0 !important; overflow: hidden; page-break-after: avoid; }
      }
      
      /* =========================================
         6. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (Modals & Toasts)
         ========================================= */
      .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(3px); opacity: 0; transition: opacity 0.3s; }
      .modal-overlay.show { opacity: 1; }
      .modal-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      .modal-overlay.show .modal-box { transform: scale(1); }
      
      .modal-header { font-weight: 700; font-size: 1.25rem; margin-bottom: 15px; border-bottom: 2px solid #f1f1f1; padding-bottom: 12px; color: var(--primary-color); }
      .modal-body { margin-bottom: 25px; font-size: 0.95rem; line-height: 1.6; color: #555; }
      .modal-footer { text-align: right; display: flex; gap: 12px; justify-content: flex-end; }
      .modal-btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 0.9rem; }
      .btn-cancel { background: #e0e0e0; color: #555; }
      .btn-cancel:hover { background: #d0d0d0; }
      .btn-confirm { background: var(--secondary-color); color: white; box-shadow: 0 2px 5px rgba(52,152,219,0.3); }
      .btn-confirm:hover { background: #2980b9; transform: translateY(-1px); }
      .btn-danger { background: var(--accent-color-ui); color: white; }
      .btn-danger:hover { background: #c0392b; }

      .toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
      .toast { 
        background: #333; color: white; padding: 15px 25px; border-radius: 8px; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: bold; 
        display: flex; align-items: center; gap: 10px; 
        transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 300px;
      }
      .toast.show { transform: translateX(0); }
      .toast-success { background: var(--success-color); }
      .toast-error { background: var(--accent-color-ui); }
      .toast-info { background: var(--secondary-color); }
      .toast-icon { font-size: 1.2rem; }

      /* ã‚¿ã‚°ç®¡ç†ãƒªã‚¹ãƒˆ */
      .tag-manage-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 5px; margin-bottom: 15px; }
      .tag-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #f9f9f9; padding-bottom: 5px; }
      .tag-row input { padding: 5px; font-size: 0.85rem; border: 1px solid #ddd; border-radius: 4px; }

    </style>
  </head>
  <body>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="toast-container" class="toast-container"></div>

    <div class="top-bar">
      <span class="bar-title"><span class="logo-icon">ğŸ“°</span> æ–°èç·¨é›†å®¤ <span style="font-size:0.7em; opacity:0.8; font-weight:normal; margin-left:5px;">Professional Ver.1.0</span></span>
      <button class="top-btn btn-save" onclick="openSaveModal()">ğŸ’¾ ä¸€æ™‚ä¿å­˜</button>
      <button class="top-btn btn-load" onclick="openLoadModal()">ğŸ“‚ å‘¼å‡º</button>
      <button class="top-btn btn-template" onclick="openTemplateModal()">ğŸ¨ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
      <button class="top-btn btn-tags" onclick="openTagsModal()">ğŸ·ï¸ ã‚¿ã‚°è¨­å®š</button>
      <div style="flex:1;"></div>
      <a href="<?= ScriptApp.getService().getUrl() ?>" class="top-btn" target="_top">ğŸ“ æŠ•ç¨¿ç”»é¢ã¸</a>
    </div>

    <div class="admin-panel">
      <div class="config-section">
        
        <div class="config-col">
          <h3>ğŸ“ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š</h3>
          <div class="control-group"><label>ç”¨ç´™å‘ã</label>
            <select id="paperOri" onchange="updateLayout()"><option value="v">ç¸¦ (A4)</option><option value="h">æ¨ª (A4)</option></select>
          </div>
          <div class="control-group"><label>æ–‡å­—ã®å‘ã</label>
            <select id="textDir" onchange="updateLayout()"><option value="vertical">ç¸¦æ›¸ã</option><option value="horizontal">æ¨ªæ›¸ã</option></select>
          </div>
          <div class="control-group"><label>æ®µçµ„ã¿</label>
            <select id="colCount" onchange="updateLayout()"><option value="1">1æ®µ</option><option value="2">2æ®µ</option><option value="3" selected>3æ®µ</option><option value="4">4æ®µ</option></select>
          </div>
          <div class="control-group">
            <label>æ–‡å­—ã‚µã‚¤ã‚º <span id="val-fontSize" style="font-weight:normal; color:var(--secondary-color); font-size:0.9em; margin-left:5px;">12px</span></label>
            <input type="range" id="fontSizeRange" min="8" max="24" value="12" step="0.5" oninput="updateStyles()">
          </div>
        </div>

        <div class="config-col">
          <h3>ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³è£…é£¾</h3>
          <div class="control-group"><label>ãƒ†ãƒ¼ãƒ (èƒŒæ™¯ãƒ»æ )</label>
            <select id="themeSelect" onchange="updateLayout()">
              <option value="default">æ¨™æº– (ç™½)</option>
              <option value="spring">ğŸŒ¸ æ˜¥ (æ¡œãƒ•ãƒ¬ãƒ¼ãƒ )</option>
              <option value="summer">ğŸŒ» å¤ (æµ·ã¨å‘æ—¥è‘µ)</option>
              <option value="autumn">ğŸ ç§‹ (ç´…è‘‰ç‹©ã‚Š)</option>
              <option value="winter">â›„ å†¬ (é›ªã®çµæ™¶)</option>
              <option value="blackboard">ğŸ« é»’æ¿ (ãƒãƒ§ãƒ¼ã‚¯é¢¨)</option>
              <option value="frame">ğŸ”³ ã‚·ãƒ³ãƒ—ãƒ«æ </option>
            </select>
          </div>

          <div class="control-group"><label>ãƒ•ã‚©ãƒ³ãƒˆ</label>
            <select id="fontFamily" onchange="updateLayout()">
              <option value="mincho">æ–°èæ˜æœ</option>
              <option value="gothic">ã‚´ã‚·ãƒƒã‚¯</option>
              <option value="ud">UDæ•™ç§‘æ›¸ä½“ (èª­ã¿ã‚„ã™ã„)</option>
              <option value="yomogi">ã‚ˆã‚‚ã (æ‰‹æ›¸ã)</option>
              <option value="kiwi">ã‚­ã‚¦ã‚¤ä¸¸ (æ‰‹æ›¸ã)</option>
            </select>
          </div>
          <div class="control-group"><label>è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«</label>
            <select id="titleStyle" onchange="updateLayout()">
              <option value="normal">ã‚·ãƒ³ãƒ—ãƒ«ï¼ˆä¸‹ç·šï¼‰</option>
              <option value="double">äºŒé‡ç·š</option>
              <option value="leftbar">ç¸¦ç·šå¼·èª¿</option>
              <option value="outline">è¢‹æ–‡å­—</option>
              <option value="solid">é»’å¸¯</option>
              <option value="marker">ãƒãƒ¼ã‚«ãƒ¼</option>
            </select>
          </div>
          <div class="control-group"><label>ç”»åƒã‚µã‚¤ã‚ºåˆæœŸå€¤</label>
            <select id="imgSizeSelect" onchange="updateStyles()"><option value="0.96" selected>å…¨å¹… (å¤§)</option><option value="0.7">æ™®é€š</option><option value="0.4">å°</option></select>
          </div>
          <div class="control-group"><label>ç”»åƒå½¢çŠ¶åˆæœŸå€¤</label>
            <select id="imgShapeSelect" onchange="updateStyles()">
              <option value="auto">ãã®ã¾ã¾ (å…ƒ)</option><option value="1/1">æ­£æ–¹å½¢</option><option value="3/4">ç¸¦é•·</option><option value="16/9">æ¨ªé•·</option>
            </select>
          </div>
        </div>

        <div class="config-col" style="flex: 1.5;">
          <h3>ğŸ—ï¸ è¨˜äº‹ç·¨é›† <button class="btn-refresh" onclick="loadArticles()">ğŸ”„ æ›´æ–°</button></h3>
          <button class="action-btn btn-free" onclick="openFreeModal()">â• è‡ªç”±è¨˜è¿°æ¬„ã‚’è¿½åŠ </button>

          <div class="filter-box" style="background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:12px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.05);">
            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div style="display:flex; gap:10px; margin-bottom:8px;">
              <input type="text" id="searchInput" placeholder="ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢..." oninput="refreshListAndPaper()" style="flex:1;">
              <select id="tagFilter" onchange="refreshListAndPaper()" style="flex:1;">
                <option value="">ğŸ·ï¸ å…¨ã¦ã®ã‚¿ã‚°</option>
              </select>
            </div>
            
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px; font-size:0.85rem; background:white; padding:6px 10px; border-radius:6px; border:1px solid #ddd;">
              <span style="color:var(--secondary-color); font-size:1.1rem;">ğŸ“…</span>
              <input type="date" id="dateFrom" onchange="refreshListAndPaper()" style="border:none; color:#555; width:auto; flex:1;">
              <span style="color:#aaa;">ï½</span>
              <input type="date" id="dateTo" onchange="refreshListAndPaper()" style="border:none; color:#555; width:auto; flex:1;">
              <button onclick="clearDateFilter()" style="font-size:0.75rem; background:#f0f0f0; border:none; padding:4px 10px; border-radius:15px; cursor:pointer; color:#666; font-weight:bold;">ã‚¯ãƒªã‚¢</button>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:0.85rem; padding: 0 5px;">
              <label style="cursor:pointer; display:flex; align-items:center; gap:5px;"><input type="checkbox" id="showSelectedOnly" onchange="refreshListAndPaper()"> âœ… é¸æŠä¸­ã®ã¿è¡¨ç¤º</label>
              <label style="cursor:pointer; display:flex; align-items:center; gap:5px;"><input type="checkbox" id="enableDrag" onchange="toggleDrag()"> âœ‹ ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰</label>
            </div>
          </div>
          
          <div id="articleList" class="article-list">èª­ã¿è¾¼ã¿ä¸­...</div>
          <button class="action-btn btn-print" onclick="window.print()">ğŸ–¨ï¸ å°åˆ· / PDFä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div id="paper-area" class="page-a4-v font-mincho">
      <header class="newspaper-header">
        <h1 class="newspaper-title" contenteditable="true">å­¦ç´šæ–°è</h1>
        <div class="newspaper-date" contenteditable="true"></div>
      </header>
      <div id="articlesContainer" class="articles-container cols-3 vertical-mode"></div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ -->
    
    <!-- æ±ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirmModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header" id="confirmTitle">ç¢ºèª</div>
        <div class="modal-body" id="confirmMessage"></div>
        <div class="modal-footer">
          <button class="modal-btn btn-cancel" onclick="closeModal('confirmModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="modal-btn btn-danger" id="confirmActionBtn">å®Ÿè¡Œ</button>
        </div>
      </div>
    </div>

    <!-- ã‚¿ã‚°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="tagsModal" class="modal-overlay">
      <div class="modal-box" style="max-width: 500px;">
        <div class="modal-header">ã‚¿ã‚°è¨­å®šã®ç®¡ç†</div>
        <div class="modal-body">
          <p style="font-size:0.85rem; color:#666;">è¨˜è€…ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚¿ã‚°ã‚’è¨­å®šã—ã¾ã™ã€‚<br>ã‚¢ã‚¤ã‚³ãƒ³(çµµæ–‡å­—)ã€åå‰(æ¼¢å­—)ã€ãµã‚ŠãŒãªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
          <div id="tagListContainer" class="tag-manage-list"></div>
          <button onclick="addTagRow()" style="width:100%; padding:8px; background:#f0f0f0; border:1px dashed #ccc; border-radius:4px; cursor:pointer; font-weight:bold; color:#555;">ï¼‹ ã‚¿ã‚°ã‚’è¿½åŠ </button>
        </div>
        <div class="modal-footer">
          <button class="modal-btn btn-cancel" onclick="closeModal('tagsModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="modal-btn btn-confirm" onclick="executeSaveTags()">è¨­å®šã‚’ä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- è‡ªç”±è¨˜è¿°è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="freeModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header">è‡ªç”±è¨˜è¿°æ¬„ã®è¿½åŠ </div>
        <div class="modal-body">
          <label>è¦‹å‡ºã—<input type="text" id="freeTitle" value="ç·¨é›†å¾Œè¨˜"></label><br>
          <label>è¨˜è€…å<input type="text" id="freeReporter" value="ç·¨é›†éƒ¨"></label><br>
          <label>æœ¬æ–‡<textarea id="freeBody" rows="5" style="width:100%; border:1px solid #ddd; border-radius:6px; padding:8px;"></textarea></label>
        </div>
        <div class="modal-footer">
          <button class="modal-btn btn-cancel" onclick="closeModal('freeModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="modal-btn btn-confirm" onclick="addFreeArticle()">è¿½åŠ </button>
        </div>
      </div>
    </div>

    <!-- ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="saveModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header">ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜</div>
        <div class="modal-body">
          <p style="margin-top:0;">è¨˜äº‹ã®é¸æŠçŠ¶æ…‹ã€ç·¨é›†å†…å®¹ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã™ã€‚</p>
          <input type="text" id="saveName" placeholder="ä¿å­˜å (ä¾‹: 1å­¦æœŸå·_ç·¨é›†ä¸­)" style="width:100%;">
        </div>
        <div class="modal-footer">
          <button class="modal-btn btn-cancel" onclick="closeModal('saveModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="modal-btn btn-confirm" onclick="executeSave()">ä¿å­˜ã™ã‚‹</button>
        </div>
      </div>
    </div>

    <!-- å‘¼å‡ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="loadModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‘¼ã³å‡ºã—</div>
        <div class="modal-body">
          <select id="loadSelect" style="width:100%; padding:10px;"></select>
        </div>
        <div class="modal-footer">
          <button class="modal-btn btn-cancel" onclick="closeModal('loadModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="modal-btn btn-confirm" onclick="executeLoad()">å¾©å…ƒã™ã‚‹</button>
        </div>
      </div>
    </div>

    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="templateModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header">ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
        <div class="modal-body">
          <p style="font-size:0.9rem; color:#666; margin-top:0;">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®šã¨ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šã®ã¿ã‚’ä¿å­˜ãƒ»é©ç”¨ã—ã¾ã™ã€‚<br>â€»è¨˜äº‹ã®å†…å®¹ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          
          <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee; margin-bottom:15px;">
            <label style="margin-bottom:8px;">ğŸ’¾ è¨­å®šã‚’æ–°è¦ä¿å­˜</label>
            <div style="display:flex; gap:8px;">
              <input type="text" id="templateName" placeholder="ä¾‹: é»’æ¿ã‚¹ã‚¿ã‚¤ãƒ«" style="flex:1;"> 
              <button onclick="executeSaveTemplate()" style="padding:6px 12px; background:var(--success-color); color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">ä¿å­˜</button>
            </div>
          </div>
          
          <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #eee;">
            <label style="margin-bottom:8px;">ğŸ“‚ è¨­å®šã‚’é©ç”¨</label>
            <div style="display:flex; gap:8px;">
              <select id="templateSelect" style="flex:1;"></select> 
              <button onclick="executeLoadTemplate()" style="padding:6px 12px; background:#e67e22; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">é©ç”¨</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn btn-cancel" onclick="closeModal('templateModal')">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>

    <!-- JavaScriptãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      let allArticles = [], freeArticles = [], articleStates = {}, customOrder = [];
      let editedContent = {}; 
      let editingTags = [];

      // ==========================================
      // 1. åˆæœŸåŒ–ãƒ»ãƒ­ãƒ¼ãƒ‰å‡¦ç† (Init & Load)
      // ==========================================
      window.onload = function() {
        const now = new Date();
        document.querySelector('.newspaper-date').innerText = `${now.getFullYear()}å¹´ ${now.getMonth()+1}æœˆ ${now.getDate()}æ—¥ ç™ºè¡Œ`;
        loadArticles(); 
      };

      function loadArticles() {
        document.getElementById('articleList').innerText = 'é€šä¿¡ä¸­...';
        google.script.run.withSuccessHandler(data => {
          allArticles = data;
          // åˆæœŸçŠ¶æ…‹è¨­å®š
          allArticles.forEach((art, i) => {
            if (!articleStates[art.id]) {
              articleStates[art.id] = { checked: i < 3, imgPos: 'top', imgSize: 'default', imgShape: 'default', qrUrl: '', showTitle: true };
            }
          });
          updateTagFilterOptions(); 
          refreshListAndPaper();
        }).withFailureHandler(e => showToast("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + e, 'error')).getArticles();
      }

      // ==========================================
      // 2. è¡¨ç¤ºãƒ»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (Render)
      // ==========================================
      
      // è¨˜äº‹ãƒªã‚¹ãƒˆã¨ç´™é¢ã®å†æç”»
      function refreshListAndPaper() {
        try {
          let combined = [...freeArticles, ...allArticles];
          
          // ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ¼ãƒ€ãƒ¼é©ç”¨
          if (customOrder.length > 0) {
            let ordered = [], others = [];
            customOrder.forEach(id => { const f = combined.find(a => a.id === id); if(f) ordered.push(f); });
            combined.forEach(a => { if (!customOrder.includes(a.id)) others.push(a); });
            combined = [...ordered, ...others];
          }
          
          // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶
          const query = document.getElementById('searchInput').value.toLowerCase();
          const tagFilter = document.getElementById('tagFilter').value;
          const showSelected = document.getElementById('showSelectedOnly').checked;
          const dateFromVal = document.getElementById('dateFrom').value;
          const dateToVal = document.getElementById('dateTo').value;
          
          let fromTime = 0, toTime = Infinity;
          if (dateFromVal) fromTime = new Date(dateFromVal + 'T00:00:00').getTime();
          if (dateToVal) { const d = new Date(dateToVal + 'T00:00:00'); d.setDate(d.getDate() + 1); toTime = d.getTime(); }

          const listDiv = document.getElementById('articleList');
          listDiv.innerHTML = '';
          const draggable = document.getElementById('enableDrag').checked;
          if(draggable) listDiv.classList.add('drag-enabled'); else listDiv.classList.remove('drag-enabled');

          // ãƒªã‚¹ãƒˆç”Ÿæˆãƒ«ãƒ¼ãƒ—
          combined.forEach(art => {
            const state = articleStates[art.id] || {};
            
            // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
            if (showSelected && !state.checked) return;
            if (query && !(art.title+art.reporterName).toLowerCase().includes(query)) return;
            if (tagFilter && art.tag !== tagFilter && !art.isFree) return;
            if (!art.isFree && art.timestamp) { if (art.timestamp < fromTime || art.timestamp >= toTime) return; }

            const div = document.createElement('div');
            div.className = 'article-item' + (state.checked ? ' selected' : '') + (art.isFree ? ' is-free' : '');
            div.dataset.id = art.id;
            if (draggable) { div.draggable = true; addDragEvents(div); }

            const isDefSz = state.imgSize === 'default';
            const isDefSh = state.imgShape === 'default';
            const isShowTitle = state.showTitle !== false;

            div.innerHTML = `
              <div class="item-main">
                <span class="drag-handle" style="margin-right:10px; color:#ccc; cursor:${draggable ? 'grab' : 'default'};">â˜°</span>
                <label style="cursor:pointer; flex:1; display:flex; align-items:center; gap:8px;">
                  <input type="checkbox" onchange="updateState('${art.id}','checked',this.checked)" ${state.checked?'checked':''} style="width:auto;"> 
                  <span style="font-weight:bold; font-size:1rem;">${art.title}</span> <span style="font-size:0.8rem; color:#777;">(${art.reporterName})</span>
                </label>
                ${art.isFree ? `<button onclick="confirmDeleteFree('${art.id}')" style="background:none; border:none; cursor:pointer; font-size:1.1rem;" title="å‰Šé™¤">ğŸ—‘ï¸</button>` : ''}
              </div>
              ${!art.isFree ? `
              <div class="item-tag-row">
                 <div class="input-wrapper"><span style="font-size:0.8rem;">ğŸ·ï¸</span><input type="text" class="tag-input" value="${art.tag||''}" placeholder="ã‚¿ã‚°" onchange="updateArticleTag('${art.id}', this.value)"></div>
                 <div class="input-wrapper"><span style="font-size:0.8rem;">ğŸ”—</span><input type="text" class="qr-input" value="${state.qrUrl||''}" placeholder="å‹•ç”»ç­‰ã®URL(QRåŒ–)" oninput="updateState('${art.id}','qrUrl', this.value)"></div>
              </div>` : `<div class="item-tag-row"><div class="input-wrapper"><span style="font-size:0.8rem;">ğŸ”—</span><input type="text" class="qr-input" value="${state.qrUrl||''}" placeholder="å‹•ç”»ç­‰ã®URL(QRåŒ–)" oninput="updateState('${art.id}','qrUrl', this.value)"></div></div>`}
              ${state.checked && art.imageUrl ? `
              <div class="item-settings">
                 <label>é…ç½® <select onchange="updateState('${art.id}','imgPos',this.value)"><option value="top" ${state.imgPos=='top'?'selected':''}>ä¸Š</option><option value="float-left" ${state.imgPos=='float-left'?'selected':''}>å·¦å›è¾¼</option><option value="float-right" ${state.imgPos=='float-right'?'selected':''}>å³å›è¾¼</option><option value="bottom" ${state.imgPos=='bottom'?'selected':''}>ä¸‹</option></select></label>
                 <label>å¤§ <select onchange="updateState('${art.id}','imgSize',this.value)"><option value="default" ${isDefSz?'selected':''}>æ¨™æº–</option><option value="0.96" ${state.imgSize=='0.96'?'selected':''}>å¤§</option><option value="0.7" ${state.imgSize=='0.7'?'selected':''}>ä¸­</option><option value="0.4" ${state.imgSize=='0.4'?'selected':''}>å°</option></select></label>
                 <label>å½¢ <select onchange="updateState('${art.id}','imgShape',this.value)"><option value="default" ${isDefSh?'selected':''}>æ¨™æº–</option><option value="auto" ${state.imgShape=='auto'?'selected':''}>å…ƒ</option><option value="1/1" ${state.imgShape=='1/1'?'selected':''}>æ­£æ–¹</option><option value="16/9" ${state.imgShape=='16/9'?'selected':''}>æ¨ªé•·</option><option value="3/4" ${state.imgShape=='3/4'?'selected':''}>ç¸¦é•·</option></select></label>
                 <label style="margin-left:auto; border-left:1px solid #ccc; padding-left:10px;"><input type="checkbox" onchange="updateState('${art.id}','showTitle', !this.checked)" ${!isShowTitle?'checked':''} style="width:auto;"> è¦‹å‡ºã—éš ã™</label>
              </div>` : ''}`;
            listDiv.appendChild(div);
          });

          // ç´™é¢ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œ
          renderPaper(combined.filter(a => (articleStates[a.id]||{}).checked));
        
        } catch(e) { console.error(e); }
      }

      // ç´™é¢ã®HTMLæ§‹ç¯‰
      function renderPaper(list) {
        const container = document.getElementById('articlesContainer');
        container.innerHTML = '';
        const globalScale = document.getElementById('imgSizeSelect').value;
        const globalShape = document.getElementById('imgShapeSelect').value;

        list.forEach(art => {
          try {
            const state = articleStates[art.id] || {};
            const box = document.createElement('div');
            box.className = 'article-box';
            
            // ç”»åƒ
            let imgHtml = '';
            if (art.imageUrl) {
               const imScale = (state.imgSize && state.imgSize !== 'default') ? state.imgSize : globalScale;
               const imShape = (state.imgShape && state.imgShape !== 'default') ? state.imgShape : globalShape;
               let style = `width:calc(var(--col-base-px) * ${imScale});`;
               let fitMode = 'cover';
               if (imShape === 'auto') { style += `height: auto; aspect-ratio: auto;`; fitMode = 'contain'; } 
               else { style += `aspect-ratio: ${imShape};`; }
               style += `--local-fit:${fitMode};`;
               let cls = 'article-img-wrapper';
               if(state.imgPos==='float-left') cls += ' img-float-left';
               if(state.imgPos==='float-right') cls += ' img-float-right';
               imgHtml = `<div class="${cls}" style="${style}"><img src="${art.imageUrl}" referrerpolicy="no-referrer"></div>`;
            }

            // QR
            let qrHtml = '';
            if (state.qrUrl && state.qrUrl.startsWith('http')) {
              const qrId = 'qr_' + art.id;
              qrHtml = `<div class="qr-container"><canvas id="${qrId}"></canvas><div class="qr-label">LINK</div></div>`;
              setTimeout(() => {
                const canvas = document.getElementById(qrId);
                if (canvas) {
                  new QRious({ element: canvas, value: state.qrUrl, size: 50, level: 'L' });
                }
              }, 0);
            }

            // ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†å†…å®¹ã®åæ˜ 
            const edits = editedContent[art.id] || {};
            const titleText = edits.title !== undefined ? edits.title : art.title;
            const reporterText = edits.reporter !== undefined ? edits.reporter : art.reporterName;
            const bodyText = edits.body !== undefined ? edits.body : art.body;
            const safeId = art.id.replace(/['"\\]/g, ''); 
            const showTitle = state.showTitle !== false; 

            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„çµ„ã¿ç«‹ã¦
            let h = '';
            if (showTitle) {
               h = `<div class="article-title" contenteditable="true" onblur="saveEdit('${safeId}', 'title', this.innerText)">${titleText}</div>
                    <div class="article-meta" contenteditable="true" onblur="saveEdit('${safeId}', 'reporter', this.innerText)">${reporterText}</div>`;
            }
            const b = `<div class="article-body" contenteditable="true" onblur="saveEdit('${safeId}', 'body', this.innerText)">${bodyText}</div>`;
            
            let content = '';
            // ç”»åƒé…ç½®ã«ã‚ˆã‚‹åˆ†å²
            if (state.imgPos === 'bottom') content = h + b + qrHtml + imgHtml;
            else if (state.imgPos === 'float-left' || state.imgPos === 'float-right') content = h + imgHtml + b + qrHtml;
            else content = h + imgHtml + b + qrHtml;
            
            box.innerHTML = content;
            container.appendChild(box);
          } catch (e) { console.error("Render error for article " + art.id, e); }
        });
        updateLayout();
      }

      function updateLayout() {
        const ori = document.getElementById('paperOri').value;
        const dir = document.getElementById('textDir').value;
        const col = parseInt(document.getElementById('colCount').value);
        const font = document.getElementById('fontFamily').value;
        const theme = document.getElementById('themeSelect').value; 
        
        const paper = document.getElementById('paper-area');
        paper.className = (ori==='h'?'page-a4-h':'page-a4-v') + ' font-' + font + ' theme-' + theme;
        
        const cont = document.getElementById('articlesContainer');
        cont.className = 'articles-container cols-' + col + (dir==='vertical'?' vertical-mode':'');
        cont.classList.remove('title-normal','title-outline','title-solid','title-double','title-leftbar','title-marker');
        cont.classList.add('title-' + document.getElementById('titleStyle').value);

        document.getElementById('dynamic-print-style').innerHTML = ori==='h' ? '@page{size:A4 landscape;margin:0}' : '@page{size:A4 portrait;margin:0}';

        // æ®µçµ„ã¿è¨ˆç®—ç”¨
        const mmToPx = 3.78;
        const padding = 24 * mmToPx; 
        const paperW = (ori === 'h' ? 297 : 210) * mmToPx;
        const gapPx = (col===2?30:col===3?20:col===4?15:0) * mmToPx;
        const colWidth = ((paperW - padding) - (gapPx * (col - 1))) / col;
        document.documentElement.style.setProperty('--col-base-px', colWidth + 'px');
      }

      // ==========================================
      // 3. UIã‚¢ã‚¯ã‚·ãƒ§ãƒ³ & ãƒ˜ãƒ«ãƒ‘ãƒ¼ (Actions)
      // ==========================================

      function updateStyles() {
        const root = document.documentElement;
        const v = document.getElementById('fontSizeRange').value;
        root.style.setProperty('--base-font-size', v + 'px');
        document.getElementById('val-fontSize').innerText = v + 'px';
        renderPaper(getDisplayedArticles());
      }

      function updateTagFilterOptions() {
        const select = document.getElementById('tagFilter');
        const currentVal = select.value;
        select.innerHTML = '<option value="">ğŸ·ï¸ å…¨ã¦ã®ã‚¿ã‚°</option>';
        const tags = new Set();
        allArticles.forEach(a => { if(a.tag) tags.add(a.tag); });
        tags.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t; opt.text = `ğŸ·ï¸ ${t}`;
          select.add(opt);
        });
        select.value = currentVal;
      }

      function updateArticleTag(id, val) {
        const art = allArticles.find(a => a.id === id);
        if(art) {
          art.tag = val;
          google.script.run.withSuccessHandler(()=>{ updateTagFilterOptions(); }).updateArticleTag(id, val);
        }
      }

      function updateState(id, k, v) { 
        if(!articleStates[id]) articleStates[id]={}; 
        articleStates[id][k]=v; 
        if(k === 'checked' || k === 'qrUrl' || k === 'showTitle') refreshListAndPaper(); 
        else renderPaper(getDisplayedArticles());
      }

      function saveEdit(id, field, value) {
        if (!editedContent[id]) editedContent[id] = {};
        editedContent[id][field] = value;
      }

      function clearDateFilter() {
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        refreshListAndPaper();
      }

      function getDisplayedArticles() {
         let combined = [...freeArticles, ...allArticles];
         if (customOrder.length > 0) {
            let ordered = [], others = [];
            customOrder.forEach(id => { const f = combined.find(a => a.id === id); if(f) ordered.push(f); });
            combined.forEach(a => { if (!customOrder.includes(a.id)) others.push(a); });
            combined = [...ordered, ...others];
         }
         return combined.filter(a => (articleStates[a.id]||{}).checked);
      }

      function toggleDrag() { refreshListAndPaper(); }
      
      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
      function addDragEvents(d) {
        d.addEventListener('dragstart',()=>d.classList.add('dragging'));
        d.addEventListener('dragend',()=>{
          d.classList.remove('dragging'); 
          customOrder=[...document.querySelectorAll('#articleList .article-item')].map(e=>e.dataset.id); 
          refreshListAndPaper();
        });
        document.getElementById('articleList').addEventListener('dragover',e=>{
          e.preventDefault(); 
          const a=getDragAfterElement(document.getElementById('articleList'),e.clientY);
          const dr=document.querySelector('.dragging'); 
          if(a==null) document.getElementById('articleList').appendChild(dr); 
          else document.getElementById('articleList').insertBefore(dr,a);
        });
      }
      function getDragAfterElement(c,y){
        return [...c.querySelectorAll('.article-item:not(.dragging)')].reduce((cl,ch)=>{
          const b=ch.getBoundingClientRect(); 
          const o=y-b.top-b.height/2; 
          return (o<0 && o>cl.offset)?{offset:o,element:ch}:cl;
        },{offset:Number.NEGATIVE_INFINITY}).element;
      }

      // ==========================================
      // 4. ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»å¾©å…ƒ (Persistence)
      // ==========================================

      function executeSave(){
        const n=document.getElementById('saveName').value; if(!n) { showToast('ä¿å­˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
        const d={ free:freeArticles, state:articleStates, order:customOrder, edits: editedContent, 
          conf:{ 
            ori:document.getElementById('paperOri').value, dir:document.getElementById('textDir').value, col:document.getElementById('colCount').value,
            titleStyle: document.getElementById('titleStyle').value, fontFamily: document.getElementById('fontFamily').value, fontSize: document.getElementById('fontSizeRange').value,
            theme: document.getElementById('themeSelect').value
          } 
        };
        google.script.run.withSuccessHandler(r=>{
          showToast(r.message, 'success'); closeModal('saveModal');
        }).saveLayoutState(n, JSON.stringify(d));
      }

      function executeLoad(){
        const n=document.getElementById('loadSelect').value; if(!n)return;
        google.script.run.withSuccessHandler(r=>{
           if(r.success){ 
             const d=JSON.parse(r.data); freeArticles=d.free||[]; articleStates=d.state||{}; customOrder=d.order||[]; editedContent=d.edits||{}; 
             if(d.conf){ 
               document.getElementById('paperOri').value=d.conf.ori; document.getElementById('textDir').value=d.conf.dir; document.getElementById('colCount').value=d.conf.col;
               if(d.conf.titleStyle) document.getElementById('titleStyle').value = d.conf.titleStyle;
               if(d.conf.fontFamily) document.getElementById('fontFamily').value = d.conf.fontFamily;
               if(d.conf.fontSize) { document.getElementById('fontSizeRange').value = d.conf.fontSize; updateStyles(); }
               if(d.conf.theme) document.getElementById('themeSelect').value = d.conf.theme;
             }
             refreshListAndPaper(); closeModal('loadModal'); showToast('å¾©å…ƒã—ã¾ã—ãŸ', 'success');
           } else showToast(r.message, 'error');
        }).loadLayoutState(n);
      }

      function executeSaveTemplate() {
        const name = document.getElementById('templateName').value;
        if(!name) { showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
        const config = {
          ori: document.getElementById('paperOri').value, dir: document.getElementById('textDir').value, col: document.getElementById('colCount').value,
          fontSize: document.getElementById('fontSizeRange').value, fontFamily: document.getElementById('fontFamily').value,
          titleStyle: document.getElementById('titleStyle').value, imgSize: document.getElementById('imgSizeSelect').value,
          imgShape: document.getElementById('imgShapeSelect').value, theme: document.getElementById('themeSelect').value
        };
        google.script.run.withSuccessHandler(r => { showToast(r.message, 'success'); openTemplateModal(); }).saveTemplate(name, JSON.stringify(config));
      }

      function executeLoadTemplate() {
        const name = document.getElementById('templateSelect').value; if(!name) return;
        google.script.run.withSuccessHandler(r => {
          if(r.success) {
            const c = JSON.parse(r.data);
            if(c.ori) document.getElementById('paperOri').value = c.ori; if(c.dir) document.getElementById('textDir').value = c.dir;
            if(c.col) document.getElementById('colCount').value = c.col; if(c.fontSize) { document.getElementById('fontSizeRange').value = c.fontSize; updateStyles(); }
            if(c.fontFamily) document.getElementById('fontFamily').value = c.fontFamily; if(c.titleStyle) document.getElementById('titleStyle').value = c.titleStyle;
            if(c.imgSize) document.getElementById('imgSizeSelect').value = c.imgSize; if(c.imgShape) document.getElementById('imgShapeSelect').value = c.imgShape;
            if(c.theme) document.getElementById('themeSelect').value = c.theme;
            updateLayout(); renderPaper(getDisplayedArticles()); closeModal('templateModal'); showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ' + name + 'ã€ã‚’é©ç”¨ã—ã¾ã—ãŸ', 'success');
          } else { showToast(r.message, 'error'); }
        }).loadTemplate(name);
      }

      // ==========================================
      // 5. ã‚¿ã‚°ç®¡ç† & è‡ªç”±è¨˜è¿° (Tag & Free)
      // ==========================================

      function openTagsModal() {
        openModal('tagsModal');
        document.getElementById('tagListContainer').innerHTML = 'èª­ã¿è¾¼ã¿ä¸­...';
        google.script.run.withSuccessHandler(tags => { editingTags = tags; renderTagList(); }).getTagsSettings();
      }
      function renderTagList() {
        const c = document.getElementById('tagListContainer'); c.innerHTML = '';
        editingTags.forEach((t, i) => {
          const div = document.createElement('div'); div.className = 'tag-row';
          div.innerHTML = `
            <input type="text" value="${t.icon}" style="width:40px; text-align:center;" placeholder="çµµ" onchange="updateTag(${i},'icon',this.value)">
            <input type="text" value="${t.name}" style="flex:1;" placeholder="åå‰" onchange="updateTag(${i},'name',this.value)">
            <input type="text" value="${t.ruby}" style="flex:1;" placeholder="ãµã‚ŠãŒãª" onchange="updateTag(${i},'ruby',this.value)">
            <button onclick="deleteTag(${i})" style="background:#e74c3c; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">Ã—</button>
          `;
          c.appendChild(div);
        });
      }
      function updateTag(idx, field, val) { editingTags[idx][field] = val; }
      function addTagRow() { editingTags.push({icon: "ğŸ·ï¸", name: "", ruby: ""}); renderTagList(); }
      function deleteTag(idx) { editingTags.splice(idx, 1); renderTagList(); }
      function executeSaveTags() {
        const validTags = editingTags.filter(t => t.name.trim() !== "");
        google.script.run.withSuccessHandler(() => { showToast('ã‚¿ã‚°è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success'); closeModal('tagsModal'); }).saveTagsSettings(JSON.stringify(validTags));
      }

      function addFreeArticle(){
        const t=document.getElementById('freeTitle').value; const r=document.getElementById('freeReporter').value || "ç·¨é›†éƒ¨"; const b=document.getElementById('freeBody').value;
        if(!t)return; const id='free_'+Date.now();
        freeArticles.push({id:id, title:t, body:b, isFree:true, reporterName:r});
        articleStates[id]={checked:true, imgPos:'top', imgSize:'default', imgShape:'default', qrUrl:'', showTitle: true};
        customOrder.unshift(id); closeModal('freeModal'); refreshListAndPaper(); showToast('è‡ªç”±è¨˜è¿°æ¬„ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
      }
      function confirmDeleteFree(id) {
        document.getElementById('confirmTitle').innerText = 'å‰Šé™¤ã®ç¢ºèª'; document.getElementById('confirmMessage').innerText = 'ã“ã®è‡ªç”±è¨˜è¿°æ¬„ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';
        const btn = document.getElementById('confirmActionBtn');
        btn.onclick = function() { freeArticles = freeArticles.filter(a => a.id !== id); refreshListAndPaper(); closeModal('confirmModal'); showToast('å‰Šé™¤ã—ã¾ã—ãŸ', 'info'); };
        openModal('confirmModal');
      }

      // ==========================================
      // 6. UIãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (UI Utils)
      // ==========================================
      function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div'); toast.className = `toast toast-${type}`;
        let icon = 'â„¹ï¸'; if (type === 'success') icon = 'âœ…'; if (type === 'error') icon = 'âš ï¸';
        toast.innerHTML = `<span class="toast-icon">${icon}</span> <span>${message}</span>`;
        container.appendChild(toast);
        requestAnimationFrame(() => { toast.classList.add('show'); });
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { toast.remove(); }, 300); }, 3000);
      }
      function openModal(id){ const m = document.getElementById(id); m.style.display='flex'; setTimeout(()=>m.classList.add('show'), 10); }
      function closeModal(id){ const m = document.getElementById(id); m.classList.remove('show'); setTimeout(()=>m.style.display='none', 300); }
      function openFreeModal(){openModal('freeModal');} function openSaveModal(){openModal('saveModal');}
      function openLoadModal(){ openModal('loadModal'); const s=document.getElementById('loadSelect'); s.innerHTML='<option>èª­è¾¼ä¸­...</option>'; google.script.run.withSuccessHandler(lst=>{ s.innerHTML=''; lst.forEach(i=> { let o=document.createElement('option'); o.value=i.name; o.text=`${i.name} (${i.date})`; s.add(o); }); }).getSavedList(); }
      function openTemplateModal() { openModal('templateModal'); const s = document.getElementById('templateSelect'); s.innerHTML = '<option>èª­è¾¼ä¸­...</option>'; google.script.run.withSuccessHandler(list => { s.innerHTML = ''; list.forEach(item => { const o = document.createElement('option'); o.value = item.name; o.text = item.name; s.add(o); }); if(list.length === 0) s.innerHTML = '<option value="">ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</option>'; }).getTemplateList(); }

    </script>
  </body>
</html>
