<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°èç·¨é›†å®¤ Professional Ver.7.0</title>
    <!-- ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿ -->
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Yomogi&family=Kiwi+Maru:wght@400;500&family=Potta+One&display=swap" rel="stylesheet">
    
    <style id="dynamic-print-style"></style>

    <style>
      /* --- åŸºæœ¬è¨­å®š --- */
      body { font-family: "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background: #333; color: #333; }
      
      /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
      .top-bar { background: #2c3e50; padding: 12px 20px; border-radius: 8px 8px 0 0; display: flex; gap: 15px; align-items: center; color: white; flex-wrap: wrap; }
      .bar-title { font-weight: bold; font-size: 1.1rem; margin-right: auto; }
      .top-btn { background: #34495e; color: white; border: 1px solid #7f8c8d; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition:0.2s; white-space: nowrap; }
      .top-btn:hover { background: #455a64; }
      .btn-save { background: #27ae60; border-color: #2ecc71; }
      .btn-load { background: #e67e22; border-color: #d35400; }
      .btn-template { background: #8e44ad; border-color: #9b59b6; margin-left: 10px; } /* New Template Btn */

      /* --- ç®¡ç†ãƒ‘ãƒãƒ« --- */
      .admin-panel { background: #f5f5f5; padding: 20px; border-radius: 0 0 12px 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
      .config-section { display: flex; gap: 20px; flex-wrap: wrap; }
      .config-col { flex: 1; min-width: 260px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      .config-col h3 { margin-top: 0; font-size: 1rem; color: #007bff; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; margin-bottom: 12px; }

      .control-group { margin-bottom: 12px; }
      .control-group label { font-weight: bold; font-size: 0.85rem; display: block; margin-bottom: 4px; color: #555; }
      input[type="range"], select, input[type="text"] { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
      
      .action-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; margin-top: 8px; }
      .btn-print { background: #2e7d32; box-shadow: 0 3px 0 #1b5e20; }
      .btn-print:active { transform: translateY(3px); box-shadow: none; }
      .btn-free { background: #8e44ad; margin-bottom: 10px; font-size: 0.9rem;} 
      .btn-refresh { background: #1976d2; color: white; border: none; padding: 4px 8px; font-size: 0.8rem; border-radius: 3px; cursor: pointer; margin-left: 10px;}

      /* --- è¨˜äº‹ãƒªã‚¹ãƒˆã‚¨ãƒªã‚¢ --- */
      .article-list { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; background: #fafafa; border-radius: 4px; }
      .article-item { background: white; border-bottom: 1px solid #eee; padding: 10px; margin-bottom: 5px; border-radius: 4px; transition: 0.2s; border-left: 4px solid transparent; }
      .article-item.selected { border-left-color: #2ecc71; background: #f0fff4; }
      .article-item.is-free { border-left-color: #9b59b6; background: #fdf2ff; }
      
      .item-main { display: flex; align-items: center; margin-bottom: 8px; }
      .item-tag-row { display:flex; align-items:center; gap:5px; margin-top:5px; margin-bottom:5px; } /* New Tag Row */
      .tag-input { font-size: 0.75rem; padding: 2px 5px; border: 1px solid #ddd; border-radius: 3px; width: 100px; color: #666; }
      
      .item-settings { 
        margin-left: 20px; display: flex; gap: 8px; flex-wrap: wrap; 
        background: #f8f9fa; padding: 5px; border-radius: 4px; border: 1px solid #eee;
      }
      .item-settings label { font-size: 0.75rem; color: #666; display: flex; align-items: center; gap: 3px; }
      .item-settings select { width: auto; font-size: 0.75rem; padding: 2px 5px; height: 24px; border: 1px solid #ccc; background: white; }

      /* --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (æ–°èç´™é¢) --- */
      #paper-area { background: white; margin: 0 auto; padding: 12mm; box-shadow: 0 0 30px rgba(0,0,0,0.5); box-sizing: border-box; overflow: hidden; position: relative; }
      
      /* ãƒ•ã‚©ãƒ³ãƒˆã‚¯ãƒ©ã‚¹å®šç¾© */
      .font-mincho { font-family: "Shippori Mincho", "Hiragino Mincho ProN", serif !important; }
      .font-gothic { font-family: "Noto Sans JP", sans-serif !important; }
      .font-yomogi { font-family: "Yomogi", cursive !important; }
      .font-kiwi { font-family: "Kiwi Maru", serif !important; }
      .font-potta { font-family: "Potta One", cursive !important; }

      .page-a4-v { width: 210mm; height: 297mm; } .page-a4-h { width: 297mm; height: 210mm; }
      
      .newspaper-header { text-align: center; border-bottom: 4px double #333; margin-bottom: 15px; padding-bottom: 10px; height: 10%; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; }
      .newspaper-title { font-size: 3rem; margin: 0; line-height: 1; letter-spacing: 0.1em; outline: none; }
      .newspaper-date { text-align: right; font-size: 0.9rem; margin-top: 10px; outline: none; }

      .articles-container { width: 100%; height: 88%; }
      :root { --base-font-size: 12px; --col-base-px: 200px; --global-img-scale: 0.96; }

      .article-box { 
        margin-bottom: 15px; padding: 8px; font-size: var(--base-font-size); text-align: justify; 
        break-inside: auto; overflow: visible; position: relative;
        max-width: 100%; box-sizing: border-box; min-height: 2em;
      }
      .article-box::after { content: ""; display: block; clear: both; }

      .article-title, .article-img-wrapper, .article-meta { break-inside: avoid; }
      
      [contenteditable="true"]:hover { background-color: rgba(255, 235, 59, 0.2); outline: 1px dashed #ccc; cursor: text; }
      [contenteditable="true"]:focus { background-color: rgba(255, 235, 59, 0.4); outline: 2px solid #007bff; }

      .article-title { font-weight: 700; font-size: 1.5em; line-height: 1.3; margin-bottom: 6px; display: block; }
      .title-normal .article-title { border-bottom: 2px solid #333; }
      .title-outline .article-title { color: white; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; border-bottom: 4px solid #000; padding: 2px 5px; }
      .title-solid .article-title { background: #000; color: #fff; padding: 4px 10px; border-radius: 3px; }
      .title-double .article-title { border-bottom: 3px double #333; padding-bottom: 2px; }
      .title-leftbar .article-title { border-left: 6px solid #333; padding-left: 10px; border-bottom: 1px solid #ccc; }
      .title-marker .article-title { background: linear-gradient(transparent 60%, #ffecb3 60%); padding: 0 5px; display: inline; box-decoration-break: clone; -webkit-box-decoration-break: clone; }

      .article-meta { font-size: 0.8em; color: #555; margin-bottom: 5px; text-align: right; display: block; }
      .article-body { line-height: 1.7; white-space: pre-wrap; font-size: 1em; overflow-wrap: break-word; }

      .article-img-wrapper { writing-mode: horizontal-tb; display: block; margin: 5px auto 8px auto; max-width: 100% !important; box-sizing: border-box; overflow: hidden; border: 1px solid #ccc; }
      .article-img-wrapper img { width: 100%; height: 100%; display: block; object-fit: var(--local-fit, cover); object-position: center; }
      .img-float-left { float: left; margin: 0 10px 5px 0; max-width: 50% !important; }
      .img-float-right { float: right; margin: 0 0 5px 10px; max-width: 50% !important; }

      .vertical-mode { writing-mode: vertical-rl; text-orientation: upright; column-fill: auto; }
      .vertical-mode .article-box { border-left: 1px solid #ddd; padding-left: 10px; margin-left: 10px; margin-bottom: 0; border-bottom: none !important; padding-bottom: 0; }
      .vertical-mode .article-title { margin-left: 10px; margin-bottom: 0; }
      .vertical-mode.title-normal .article-title { border-bottom: none; border-left: 2px solid #333; padding-left: 5px; }
      .vertical-mode.title-outline .article-title { border-left: 4px solid #000; border-bottom: none; }
      .vertical-mode.title-solid .article-title { border-left: none; }
      .vertical-mode.title-double .article-title { border-bottom: none; border-left: 3px double #333; padding-left: 5px; }
      .vertical-mode.title-leftbar .article-title { border-left: none; border-top: 6px solid #333; padding-top: 10px; border-bottom: none; border-right: 1px solid #ccc; padding-right:10px; }
      .vertical-mode.title-marker .article-title { background: linear-gradient(to left, transparent 60%, #ffecb3 60%); }
      .vertical-mode .img-float-left { float: left; margin: 0 0 10px 10px; }
      .vertical-mode .img-float-right { float: right; margin: 10px 0 10px 0; }

      .cols-1 { column-count: 1; } 
      .cols-2 { column-count: 2; column-gap: 30px; column-rule: 1px solid #ccc; }
      .cols-3 { column-count: 3; column-gap: 20px; column-rule: 1px solid #ccc; } 
      .cols-4 { column-count: 4; column-gap: 15px; column-rule: 1px solid #ccc; }

      @media print {
        body { margin: 0; padding: 0; background: white; }
        .top-bar, .admin-panel, .modal-overlay { display: none !important; }
        #paper-area { box-shadow: none; margin: 0 !important; padding: 10mm !important; overflow: hidden; page-break-after: avoid; }
      }
      
      /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
      .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
      .modal-box { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
      .modal-header { font-weight: bold; font-size: 1.2rem; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
      .modal-body { margin-bottom: 20px; }
      .modal-footer { text-align: right; display: flex; gap: 10px; justify-content: flex-end; }
      .modal-btn { padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
      .btn-cancel { background: #ccc; color: #333; }
      .btn-confirm { background: #007bff; color: white; }
      .btn-load-template { background: #8e44ad; color: white; }
    </style>
  </head>
  <body>

    <div class="top-bar">
      <span class="bar-title">ğŸ“° ç·¨é›†å®¤ Ver.7.0</span>
      <button class="top-btn btn-save" onclick="openSaveModal()">ä¸€æ™‚ä¿å­˜</button>
      <button class="top-btn btn-load" onclick="openLoadModal()">å‘¼å‡º</button>
      <button class="top-btn btn-template" onclick="openTemplateModal()">ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button> <!-- New -->
      <div style="flex:1;"></div>
      <a href="<?= ScriptApp.getService().getUrl() ?>" class="top-btn" target="_top">â† æŠ•ç¨¿ç”»é¢ã¸</a>
    </div>

    <div class="admin-panel">
      <div class="config-section">
        
        <div class="config-col">
          <h3>1. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</h3>
          <div class="control-group"><label>ç”¨ç´™å‘ã</label>
            <select id="paperOri" onchange="updateLayout()"><option value="v">ç¸¦ (A4)</option><option value="h">æ¨ª (A4)</option></select>
          </div>
          <div class="control-group"><label>æ–‡å­—ã®å‘ã</label>
            <select id="textDir" onchange="updateLayout()"><option value="vertical">ç¸¦æ›¸ã</option><option value="horizontal">æ¨ªæ›¸ã</option></select>
          </div>
          <div class="control-group"><label>æ®µçµ„ã¿</label>
            <select id="colCount" onchange="updateLayout()"><option value="1">1æ®µ</option><option value="2">2æ®µ</option><option value="3" selected>3æ®µ</option><option value="4">4æ®µ</option></select>
          </div>
          <div class="control-group">
            <label>æ–‡å­—ã‚µã‚¤ã‚º <span id="val-fontSize" style="font-weight:normal; color:#007bff; font-size:0.9em; margin-left:5px;">12px</span></label>
            <input type="range" id="fontSizeRange" min="8" max="24" value="12" step="0.5" oninput="updateStyles()">
          </div>
        </div>

        <div class="config-col">
          <h3>2. ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š</h3>
          <div class="control-group"><label>ãƒ•ã‚©ãƒ³ãƒˆ</label>
            <select id="fontFamily" onchange="updateLayout()">
              <option value="mincho">æ–°èæ˜æœ</option>
              <option value="gothic">ã‚´ã‚·ãƒƒã‚¯</option>
              <option value="yomogi">ã‚ˆã‚‚ã (æ‰‹æ›¸ã)</option>
              <option value="kiwi">ã‚­ã‚¦ã‚¤ä¸¸ (æ‰‹æ›¸ã)</option>
              <option value="potta">ãƒãƒƒã‚¿ (å¤ªæ–‡å­—æ‰‹æ›¸ã)</option>
            </select>
          </div>
          <div class="control-group"><label>è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«</label>
            <select id="titleStyle" onchange="updateLayout()">
              <option value="normal">ã‚·ãƒ³ãƒ—ãƒ«ï¼ˆä¸‹ç·šï¼‰</option>
              <option value="double">äºŒé‡ç·š</option>
              <option value="leftbar">ç¸¦ç·šå¼·èª¿</option>
              <option value="outline">è¢‹æ–‡å­—</option>
              <option value="solid">é»’å¸¯</option>
              <option value="marker">ãƒãƒ¼ã‚«ãƒ¼</option>
            </select>
          </div>
          <div class="control-group"><label>å†™çœŸã®åˆæœŸã‚µã‚¤ã‚º</label>
            <select id="imgSizeSelect" onchange="updateStyles()"><option value="0.96" selected>å…¨å¹… (å¤§)</option><option value="0.7">æ™®é€š</option><option value="0.4">å°</option></select>
          </div>
          <div class="control-group"><label>å†™çœŸã®åˆæœŸå½¢çŠ¶</label>
            <select id="imgShapeSelect" onchange="updateStyles()">
              <option value="auto">ãã®ã¾ã¾ (å…ƒ)</option><option value="1/1">æ­£æ–¹å½¢</option><option value="3/4">ç¸¦é•·</option><option value="16/9">æ¨ªé•·</option>
            </select>
          </div>
        </div>

        <div class="config-col" style="flex: 1.5;">
          <h3>3. è¨˜äº‹ç·¨é›† <button class="btn-refresh" onclick="loadArticles()">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button></h3>
          <button class="action-btn btn-free" onclick="openFreeModal()">ï¼‹ è‡ªç”±è¨˜è¿°æ¬„ã‚’è¿½åŠ </button>

          <div class="filter-box" style="background:#e3f2fd; padding:10px; border-radius:6px; margin-bottom:10px;">
            <div style="display:flex; gap:10px; margin-bottom:5px;">
              <input type="text" id="searchInput" placeholder="ğŸ” æ¤œç´¢..." oninput="refreshListAndPaper()" style="flex:1;">
              <!-- New Filter Select -->
              <select id="tagFilter" onchange="refreshListAndPaper()" style="flex:1;">
                <option value="">å…¨ã¦ã®ã‚¿ã‚°</option>
              </select>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:0.85rem;">
              <label><input type="checkbox" id="showSelectedOnly" onchange="refreshListAndPaper()"> é¸æŠä¸­ã®ã¿</label>
              <label><input type="checkbox" id="enableDrag" onchange="toggleDrag()"> âœ‹ ä¸¦æ›¿ON</label>
            </div>
          </div>
          
          <div id="articleList" class="article-list">èª­ã¿è¾¼ã¿ä¸­...</div>
          <button class="action-btn btn-print" onclick="window.print()">ğŸ–¨ï¸ å°åˆ· / PDFä¿å­˜</button>
        </div>
      </div>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div id="paper-area" class="page-a4-v font-mincho">
      <header class="newspaper-header">
        <h1 class="newspaper-title" contenteditable="true">å­¦ç´šæ–°è</h1>
        <div class="newspaper-date" contenteditable="true"></div>
      </header>
      <div id="articlesContainer" class="articles-container cols-3 vertical-mode"></div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ -->
    <div id="freeModal" class="modal-overlay"><div class="modal-box"><div class="modal-header">è‡ªç”±è¨˜è¿°æ¬„</div><div class="modal-body"><label>è¦‹å‡ºã—<input type="text" id="freeTitle" value="ç·¨é›†å¾Œè¨˜"></label><br><br><label>æœ¬æ–‡<textarea id="freeBody" rows="5" style="width:100%;"></textarea></label></div><div class="modal-footer"><button class="modal-btn btn-cancel" onclick="closeModal('freeModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="modal-btn btn-confirm" onclick="addFreeArticle()">è¿½åŠ </button></div></div></div>
    <div id="saveModal" class="modal-overlay"><div class="modal-box"><div class="modal-header">çŠ¶æ…‹ä¿å­˜ (è¨˜äº‹è¾¼ã¿)</div><div class="modal-body"><input type="text" id="saveName" placeholder="ä¿å­˜å"></div><div class="modal-footer"><button class="modal-btn btn-cancel" onclick="closeModal('saveModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="modal-btn btn-confirm" onclick="executeSave()">ä¿å­˜</button></div></div></div>
    <div id="loadModal" class="modal-overlay"><div class="modal-box"><div class="modal-header">èª­è¾¼ (è¨˜äº‹è¾¼ã¿)</div><div class="modal-body"><select id="loadSelect" style="width:100%; padding:10px;"></select></div><div class="modal-footer"><button class="modal-btn btn-cancel" onclick="closeModal('loadModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="modal-btn btn-confirm" onclick="executeLoad()">å¾©å…ƒ</button></div></div></div>
    <!-- New Template Modal -->
    <div id="templateModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header">ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</div>
        <div class="modal-body">
          <p style="font-size:0.85rem; color:#555;">ç¾åœ¨ã®ã€Œãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®šã€ã¨ã€Œãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šã€ã‚’ä¿å­˜ã—ã¾ã™ã€‚<br>â€»è¨˜äº‹ã®å†…å®¹ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚</p>
          <hr style="border:none; border-top:1px solid #eee; margin:10px 0;">
          <label>ğŸ’¾ æ–°è¦ä¿å­˜<br><input type="text" id="templateName" placeholder="ä¾‹: æœã®ä¼šç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ" style="width:70%; display:inline-block;"> <button onclick="executeSaveTemplate()" style="padding:6px; background:#27ae60; color:white; border:none; border-radius:4px; cursor:pointer;">ä¿å­˜</button></label>
          <hr style="border:none; border-top:1px solid #eee; margin:15px 0;">
          <label>ğŸ“‚ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‘¼å‡º<br>
            <select id="templateSelect" style="width:70%; display:inline-block;"></select> <button onclick="executeLoadTemplate()" style="padding:6px; background:#e67e22; color:white; border:none; border-radius:4px; cursor:pointer;">é©ç”¨</button>
          </label>
        </div>
        <div class="modal-footer"><button class="modal-btn btn-cancel" onclick="closeModal('templateModal')">é–‰ã˜ã‚‹</button></div>
      </div>
    </div>

    <script>
      let allArticles = [], freeArticles = [], articleStates = {}, customOrder = [];
      let editedContent = {}; 

      window.onload = function() {
        const now = new Date();
        document.querySelector('.newspaper-date').innerText = `${now.getFullYear()}å¹´ ${now.getMonth()+1}æœˆ ${now.getDate()}æ—¥ ç™ºè¡Œ`;
        loadArticles(); 
      };

      function loadArticles() {
        document.getElementById('articleList').innerText = 'é€šä¿¡ä¸­...';
        google.script.run.withSuccessHandler(data => {
          allArticles = data;
          allArticles.forEach((art, i) => {
            if (!articleStates[art.id]) {
              articleStates[art.id] = { checked: i < 3, imgPos: 'top', imgSize: 'default', imgShape: 'default' };
            }
          });
          updateTagFilterOptions(); // ã‚¿ã‚°ä¸€è¦§æ›´æ–°
          refreshListAndPaper();
        }).withFailureHandler(e => alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + e)).getArticles();
      }

      function updateTagFilterOptions() {
        const select = document.getElementById('tagFilter');
        const currentVal = select.value;
        select.innerHTML = '<option value="">å…¨ã¦ã®ã‚¿ã‚°</option>';
        
        // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚¿ã‚°ã‚’æŠ½å‡º
        const tags = new Set();
        allArticles.forEach(a => { if(a.tag) tags.add(a.tag); });
        
        tags.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.text = `ğŸ·ï¸ ${t}`;
          select.add(opt);
        });
        select.value = currentVal;
      }

      function refreshListAndPaper() {
        try {
          let combined = [...freeArticles, ...allArticles];
          if (customOrder.length > 0) {
            let ordered = [], others = [];
            customOrder.forEach(id => { const f = combined.find(a => a.id === id); if(f) ordered.push(f); });
            combined.forEach(a => { if (!customOrder.includes(a.id)) others.push(a); });
            combined = [...ordered, ...others];
          }
          
          const query = document.getElementById('searchInput').value.toLowerCase();
          const tagFilter = document.getElementById('tagFilter').value; // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿
          const showSelected = document.getElementById('showSelectedOnly').checked;
          const listDiv = document.getElementById('articleList');
          listDiv.innerHTML = '';
          const draggable = document.getElementById('enableDrag').checked;
          if(draggable) listDiv.classList.add('drag-enabled'); else listDiv.classList.remove('drag-enabled');

          combined.forEach(art => {
            const state = articleStates[art.id] || {};
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç†
            if (showSelected && !state.checked) return;
            if (query && !(art.title+art.reporterName).toLowerCase().includes(query)) return;
            if (tagFilter && art.tag !== tagFilter && !art.isFree) return; // è‡ªç”±è¨˜è¿°ã¯ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ç„¡è¦–(ã‚ã‚‹ã„ã¯ç‹¬è‡ªã®ã‚¿ã‚°ã‚’æŒãŸã›ã‚‹ã‹)

            const div = document.createElement('div');
            div.className = 'article-item' + (state.checked ? ' selected' : '') + (art.isFree ? ' is-free' : '');
            div.dataset.id = art.id;
            if (draggable) { div.draggable = true; addDragEvents(div); }

            const isDefSz = state.imgSize === 'default';
            const isDefSh = state.imgShape === 'default';

            div.innerHTML = `
              <div class="item-main">
                <span class="drag-handle" style="margin-right:8px; color:#ccc;">â˜°</span>
                <label style="cursor:pointer; flex:1;"><input type="checkbox" onchange="updateState('${art.id}','checked',this.checked)" ${state.checked?'checked':''}> <strong>${art.title}</strong></label>
                ${art.isFree ? `<button onclick="deleteFree('${art.id}')">ğŸ—‘ï¸</button>` : ''}
              </div>
              <!-- ã‚¿ã‚°å…¥åŠ›æ¬„ (New) -->
              ${!art.isFree ? `
              <div class="item-tag-row">
                 <span style="font-size:0.75rem; color:#666;">ğŸ·ï¸</span>
                 <input type="text" class="tag-input" value="${art.tag||''}" placeholder="ã‚¿ã‚°(è¡Œäº‹ãªã©)" onchange="updateArticleTag('${art.id}', this.value)">
              </div>` : ''}
              
              ${state.checked && art.imageUrl ? `
              <div class="item-settings">
                 <label>é…ç½®: <select onchange="updateState('${art.id}','imgPos',this.value)"><option value="top" ${state.imgPos=='top'?'selected':''}>ä¸Š</option><option value="float-left" ${state.imgPos=='float-left'?'selected':''}>å·¦å›è¾¼</option><option value="float-right" ${state.imgPos=='float-right'?'selected':''}>å³å›è¾¼</option><option value="bottom" ${state.imgPos=='bottom'?'selected':''}>ä¸‹</option></select></label>
                 <label>å¤§ã•: <select onchange="updateState('${art.id}','imgSize',this.value)"><option value="default" ${isDefSz?'selected':''}>æ¨™æº–</option><option value="0.96" ${state.imgSize=='0.96'?'selected':''}>å¤§</option><option value="0.7" ${state.imgSize=='0.7'?'selected':''}>ä¸­</option><option value="0.4" ${state.imgSize=='0.4'?'selected':''}>å°</option></select></label>
                 <label>å½¢: <select onchange="updateState('${art.id}','imgShape',this.value)"><option value="default" ${isDefSh?'selected':''}>æ¨™æº–</option><option value="auto" ${state.imgShape=='auto'?'selected':''}>å…ƒ</option><option value="1/1" ${state.imgShape=='1/1'?'selected':''}>æ­£æ–¹</option><option value="16/9" ${state.imgShape=='16/9'?'selected':''}>æ¨ªé•·</option><option value="3/4" ${state.imgShape=='3/4'?'selected':''}>ç¸¦é•·</option></select></label>
              </div>
              ` : ''}`;
            listDiv.appendChild(div);
          });

          renderPaper(combined.filter(a => (articleStates[a.id]||{}).checked));
        
        } catch(e) { console.error(e); }
      }

      function updateArticleTag(id, val) {
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        const art = allArticles.find(a => a.id === id);
        if(art) {
          art.tag = val;
          // ã‚µãƒ¼ãƒãƒ¼ã¸ä¿å­˜
          google.script.run.withSuccessHandler(()=>{
            updateTagFilterOptions(); // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ›´æ–°
            // console.log('Tag saved');
          }).updateArticleTag(id, val);
        }
      }

      function updateState(id, k, v) { 
        if(!articleStates[id]) articleStates[id]={}; 
        articleStates[id][k]=v; 
        refreshListAndPaper(); 
      }

      function renderPaper(list) {
        const container = document.getElementById('articlesContainer');
        container.innerHTML = '';
        const globalScale = document.getElementById('imgSizeSelect').value;
        const globalShape = document.getElementById('imgShapeSelect').value;

        list.forEach(art => {
          try {
            const state = articleStates[art.id] || {};
            const box = document.createElement('div');
            box.className = 'article-box';
            
            let imgHtml = '';
            if (art.imageUrl) {
               const imScale = (state.imgSize && state.imgSize !== 'default') ? state.imgSize : globalScale;
               const imShape = (state.imgShape && state.imgShape !== 'default') ? state.imgShape : globalShape;
               let style = `width:calc(var(--col-base-px) * ${imScale});`;
               let fitMode = 'cover';
               if (imShape === 'auto') { style += `height: auto; aspect-ratio: auto;`; fitMode = 'contain'; } 
               else { style += `aspect-ratio: ${imShape};`; }
               style += `--local-fit:${fitMode};`;
               let cls = 'article-img-wrapper';
               if(state.imgPos==='float-left') cls += ' img-float-left';
               if(state.imgPos==='float-right') cls += ' img-float-right';
               imgHtml = `<div class="${cls}" style="${style}"><img src="${art.imageUrl}" referrerpolicy="no-referrer"></div>`;
            }

            const edits = editedContent[art.id] || {};
            const titleText = edits.title !== undefined ? edits.title : art.title;
            const reporterText = edits.reporter !== undefined ? edits.reporter : art.reporterName;
            const bodyText = edits.body !== undefined ? edits.body : art.body;
            const safeId = art.id.replace(/['"\\]/g, ''); 

            const h = `<div class="article-title" contenteditable="true" onblur="saveEdit('${safeId}', 'title', this.innerText)">${titleText}</div>
                       <div class="article-meta" contenteditable="true" onblur="saveEdit('${safeId}', 'reporter', this.innerText)">${reporterText}</div>`;
            const b = `<div class="article-body" contenteditable="true" onblur="saveEdit('${safeId}', 'body', this.innerText)">${bodyText}</div>`;
            
            if (state.imgPos === 'bottom') box.innerHTML = h + b + imgHtml;
            else if (state.imgPos === 'float-left' || state.imgPos === 'float-right') box.innerHTML = h + imgHtml + b;
            else box.innerHTML = h + imgHtml + b;
            
            container.appendChild(box);
          } catch (e) { console.error("Render error for article " + art.id, e); }
        });
        updateLayout();
      }

      function saveEdit(id, field, value) {
        if (!editedContent[id]) editedContent[id] = {};
        editedContent[id][field] = value;
      }

      function updateLayout() {
        const ori = document.getElementById('paperOri').value;
        const dir = document.getElementById('textDir').value;
        const col = parseInt(document.getElementById('colCount').value);
        const font = document.getElementById('fontFamily').value;
        
        const paper = document.getElementById('paper-area');
        paper.className = (ori==='h'?'page-a4-h':'page-a4-v') + ' font-' + font;
        
        const cont = document.getElementById('articlesContainer');
        cont.className = 'articles-container cols-' + col + (dir==='vertical'?' vertical-mode':'');
        cont.classList.remove('title-normal','title-outline','title-solid','title-double','title-leftbar','title-marker');
        cont.classList.add('title-' + document.getElementById('titleStyle').value);

        document.getElementById('dynamic-print-style').innerHTML = ori==='h' ? '@page{size:A4 landscape;margin:0}' : '@page{size:A4 portrait;margin:0}';

        const mmToPx = 3.78;
        const padding = 24 * mmToPx; 
        const paperW = (ori === 'h' ? 297 : 210) * mmToPx;
        const gapPx = (col===2?30:col===3?20:col===4?15:0) * mmToPx;
        const colWidth = ((paperW - padding) - (gapPx * (col - 1))) / col;
        document.documentElement.style.setProperty('--col-base-px', colWidth + 'px');
      }

      function updateStyles() {
        const root = document.documentElement;
        const v = document.getElementById('fontSizeRange').value;
        root.style.setProperty('--base-font-size', v + 'px');
        document.getElementById('val-fontSize').innerText = v + 'px';
        refreshListAndPaper();
      }

      // --- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ (New) ---
      function openTemplateModal() {
        openModal('templateModal');
        const s = document.getElementById('templateSelect');
        s.innerHTML = '<option>èª­è¾¼ä¸­...</option>';
        google.script.run.withSuccessHandler(list => {
          s.innerHTML = '';
          list.forEach(item => {
            const o = document.createElement('option');
            o.value = item.name;
            o.text = item.name;
            s.add(o);
          });
          if(list.length === 0) s.innerHTML = '<option value="">ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</option>';
        }).getTemplateList();
      }

      function executeSaveTemplate() {
        const name = document.getElementById('templateName').value;
        if(!name) { alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        
        // è¨­å®šã®ã¿ã‚’æŠ½å‡º
        const config = {
          ori: document.getElementById('paperOri').value,
          dir: document.getElementById('textDir').value,
          col: document.getElementById('colCount').value,
          fontSize: document.getElementById('fontSizeRange').value,
          fontFamily: document.getElementById('fontFamily').value,
          titleStyle: document.getElementById('titleStyle').value,
          imgSize: document.getElementById('imgSizeSelect').value,
          imgShape: document.getElementById('imgShapeSelect').value
        };
        
        google.script.run.withSuccessHandler(r => {
          alert(r.message);
          openTemplateModal(); // ãƒªã‚¹ãƒˆæ›´æ–°ã®ãŸã‚å†è¡¨ç¤º
        }).saveTemplate(name, JSON.stringify(config));
      }

      function executeLoadTemplate() {
        const name = document.getElementById('templateSelect').value;
        if(!name) return;
        
        google.script.run.withSuccessHandler(r => {
          if(r.success) {
            const c = JSON.parse(r.data);
            if(c.ori) document.getElementById('paperOri').value = c.ori;
            if(c.dir) document.getElementById('textDir').value = c.dir;
            if(c.col) document.getElementById('colCount').value = c.col;
            if(c.fontSize) { document.getElementById('fontSizeRange').value = c.fontSize; updateStyles(); }
            if(c.fontFamily) document.getElementById('fontFamily').value = c.fontFamily;
            if(c.titleStyle) document.getElementById('titleStyle').value = c.titleStyle;
            if(c.imgSize) document.getElementById('imgSizeSelect').value = c.imgSize;
            if(c.imgShape) document.getElementById('imgShapeSelect').value = c.imgShape;
            
            updateLayout();
            refreshListAndPaper(); // ç”»åƒã‚¹ã‚¿ã‚¤ãƒ«ãªã©ã‚‚é©ç”¨
            closeModal('templateModal');
            alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ' + name + 'ã€ã‚’é©ç”¨ã—ã¾ã—ãŸ');
          } else {
            alert(r.message);
          }
        }).loadTemplate(name);
      }

      // --- æ—¢å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« ---
      function openModal(id){document.getElementById(id).style.display='flex';}
      function closeModal(id){document.getElementById(id).style.display='none';}
      function openFreeModal(){openModal('freeModal');}
      function openSaveModal(){openModal('saveModal');}
      function openLoadModal(){
        openModal('loadModal'); const s=document.getElementById('loadSelect'); s.innerHTML='<option>èª­è¾¼ä¸­...</option>';
        google.script.run.withSuccessHandler(lst=>{
          s.innerHTML=''; 
          lst.forEach(i=> { let o=document.createElement('option'); o.value=i.name; o.text=`${i.name} (${i.date})`; s.add(o); });
        }).getSavedList();
      }
      function addFreeArticle(){
        const t=document.getElementById('freeTitle').value; const b=document.getElementById('freeBody').value;
        if(!t)return; const id='free_'+Date.now();
        freeArticles.push({id:id, title:t, body:b, isFree:true, reporterName:"è‡ªç”±è¨˜è¿°"});
        articleStates[id]={checked:true, imgPos:'top', imgSize:'default', imgShape:'default'}; 
        customOrder.unshift(id);
        closeModal('freeModal'); refreshListAndPaper();
      }
      function deleteFree(id){ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ freeArticles=freeArticles.filter(a=>a.id!==id); refreshListAndPaper(); } }
      
      function executeSave(){
        const n=document.getElementById('saveName').value; if(!n)return;
        const d={ free:freeArticles, state:articleStates, order:customOrder, edits: editedContent, 
          conf:{ 
            ori:document.getElementById('paperOri').value, dir:document.getElementById('textDir').value, col:document.getElementById('colCount').value,
            titleStyle: document.getElementById('titleStyle').value, fontFamily: document.getElementById('fontFamily').value, fontSize: document.getElementById('fontSizeRange').value
          } 
        };
        google.script.run.withSuccessHandler(r=>{alert(r.message);closeModal('saveModal')}).saveLayoutState(n, JSON.stringify(d));
      }
      function executeLoad(){
        const n=document.getElementById('loadSelect').value; if(!n)return;
        google.script.run.withSuccessHandler(r=>{
           if(r.success){ 
             const d=JSON.parse(r.data); freeArticles=d.free||[]; articleStates=d.state||{}; customOrder=d.order||[]; editedContent=d.edits||{}; 
             if(d.conf){ 
               document.getElementById('paperOri').value=d.conf.ori; document.getElementById('textDir').value=d.conf.dir; document.getElementById('colCount').value=d.conf.col;
               if(d.conf.titleStyle) document.getElementById('titleStyle').value = d.conf.titleStyle;
               if(d.conf.fontFamily) document.getElementById('fontFamily').value = d.conf.fontFamily;
               if(d.conf.fontSize) { document.getElementById('fontSizeRange').value = d.conf.fontSize; updateStyles(); }
             }
             refreshListAndPaper(); closeModal('loadModal'); alert('å¾©å…ƒã—ã¾ã—ãŸ');
           } else alert(r.message);
        }).loadLayoutState(n);
      }
      
      function toggleDrag() { refreshListAndPaper(); }
      function addDragEvents(d) {
        d.addEventListener('dragstart',()=>d.classList.add('dragging'));
        d.addEventListener('dragend',()=>{d.classList.remove('dragging'); customOrder=[...document.querySelectorAll('#articleList .article-item')].map(e=>e.dataset.id); refreshListAndPaper();});
        document.getElementById('articleList').addEventListener('dragover',e=>{
          e.preventDefault(); const a=getDragAfterElement(document.getElementById('articleList'),e.clientY);
          const dr=document.querySelector('.dragging'); if(a==null) document.getElementById('articleList').appendChild(dr); else document.getElementById('articleList').insertBefore(dr,a);
        });
      }
      function getDragAfterElement(c,y){
        return [...c.querySelectorAll('.article-item:not(.dragging)')].reduce((cl,ch)=>{
          const b=ch.getBoundingClientRect(); const o=y-b.top-b.height/2; return (o<0 && o>cl.offset)?{offset:o,element:ch}:cl;
        },{offset:Number.NEGATIVE_INFINITY}).element;
      }
    </script>
  </body>
</html>
